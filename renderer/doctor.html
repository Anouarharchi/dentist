<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Tableau de bord - Dentiste</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ===== Global ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    html, body {
      height: 100%;
      background: #f8fafc;
      color: #334155;
      line-height: 1.5;
    }
    :root {
      --sidebar-bg: #1e293b;
      --sidebar-hover: #334155;
      --accent: #0ea5a4;
      --accent-light: #5eead4;
      --accent-dark: #0d9488;
      --muted: #64748b;
      --muted-light: #94a3b8;
      --card-bg: #ffffff;
      --danger: #ef4444;
      --danger-light: #fca5a5;
      --success: #10b981;
      --warning: #f59e0b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 8px;
    }

    /* ===== Layout ===== */
    .app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: width 0.3s ease;
      z-index: 100;
    }
    
    .sidebar-header {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 8px;
    }
    
    .brand {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .brand-icon {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .role {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
      padding-left: 34px;
    }
    
    .menu {
      flex: 1;
      overflow: auto;
      padding: 0 12px;
    }
    
    .menu-item {
      padding: 12px 14px;
      border-radius: var(--radius);
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .menu-item:hover {
      background: var(--sidebar-hover);
      color: #fff;
    }
    
    .menu-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
      box-shadow: 0 2px 5px rgba(14, 165, 164, 0.3);
    }
    
    .menu-item .label {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .menu-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .menu-item .count {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      min-width: 20px;
      text-align: center;
    }
    
    .logout-btn {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger-light);
      padding: 12px;
      border-radius: var(--radius);
      cursor: pointer;
      margin: 16px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    
    .sidebar-footer {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      padding: 12px;
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .main {
      flex: 1;
      display: flex;
      min-width: 0;
      flex-direction: row;
      overflow: hidden;
    }

    .main-content {
      flex: 1;
      padding: 24px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: #f8fafc;
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 16px;
    }
    
    .header-left {
      display: flex;
      flex-direction: column;
    }
    
    .title {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      line-height: 1.2;
    }
    
    .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      background: #f1f5f9;
      color: #475569;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .btn:hover {
      background: #e2e8f0;
    }
    
    .btn.primary {
      background: var(--accent);
      color: #fff;
    }
    
    .btn.primary:hover {
      background: var(--accent-dark);
    }
    
    .btn.warn {
      background: var(--warning);
      color: #fff;
    }
    
    .btn.danger {
      background: var(--danger);
      color: #fff;
    }
    
    .btn.danger:hover {
      background: #dc2626;
    }

    .content-area {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      min-height: 0;
      flex: 1;
      overflow: auto;
      border: 1px solid var(--border);
    }

    /* ===== Dashboard: today's appointments ===== */
    .today-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .appt-card {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: #fff;
      transition: all 0.2s ease;
    }
    
    .appt-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      transform: translateY(-1px);
    }
    
    .appt-time {
      min-width: 80px;
      font-weight: 700;
      color: #0f172a;
      font-size: 16px;
    }
    
    .appt-meta {
      flex: 1;
    }
    
    .appt-actions {
      display: flex;
      gap: 8px;
    }
    
    .patient-name {
      font-weight: 600;
      font-size: 16px;
      color: #0f172a;
    }
    
    .patient-details {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      align-items: center;
    }

    /* ===== Table generic ===== */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      border-radius: var(--radius);
      overflow: hidden;
    }
    
    .table th, .table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    
    .table th {
      background: #f8fafc;
      font-weight: 600;
      color: #475569;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table tr:last-child td {
      border-bottom: none;
    }
    
    .table tr:hover td {
      background: #f8fafc;
    }
    
    .small {
      font-size: 13px;
      color: var(--muted);
    }

    /* ===== Forms & modal ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(2px);
    }
    
    .modal {
      width: 900px;
      max-width: 96%;
      max-height: 90vh;
      overflow: auto;
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .modal h3 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #0f172a;
      font-weight: 600;
    }
    
    .form-row {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }
    
    .form-col {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-size: 14px;
      color: #374151;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    input[type="text"], input[type="date"], input[type="time"], input[type="email"], select, textarea {
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.1);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* Right panel (optional) */
    .right-panel {
      width: 320px;
      border-left: 1px solid var(--border);
      background: #f8fafc;
      padding: 24px;
      overflow: auto;
      flex-shrink: 0;
    }
    
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .search-box input {
      flex: 1;
    }
    
    .patient-card {
      background: #fff;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #0f172a;
    }

    /* small helpers */
    .muted {
      color: var(--muted);
    }
    
    .pill {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: #f1f5f9;
      color: #475569;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #fff;
    }
    
    .badge.primary {
      background: var(--accent);
    }
    
    .badge.success {
      background: var(--success);
    }
    
    .badge.warning {
      background: var(--warning);
    }
    
    .badge.danger {
      background: var(--danger);
    }
    
    .file-preview {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    
    .file-item {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: #fff;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
      line-height: 1;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--muted);
      margin-top: 8px;
    }

    /* New styles for medication form */
    .medication-section {
      margin: 20px 0;
      padding: 16px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .medication-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .medication-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }
    
    .add-medication-btn {
      background: var(--success);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      margin-left: 10px;
    }
    
    .remove-medication-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
    }

    @media (max-width: 900px) {
      .right-panel {
        display: none;
      }
      
      .sidebar {
        width: 70px;
      }
      
      .sidebar-header {
        padding: 16px 8px;
      }
      
      .brand-text, .role, .menu-item .text, .logout-btn span, .sidebar-footer {
        display: none;
      }
      
      .brand {
        justify-content: center;
      }
      
      .menu-item {
        justify-content: center;
        padding: 14px;
      }
      
      .menu-item .count {
        position: absolute;
        top: 6px;
        right: 6px;
        font-size: 10px;
        padding: 1px 4px;
      }
      
      .logout-btn {
        padding: 14px;
        justify-content: center;
      }
      
      .medication-fields {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }

  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand">
          <div class="brand-icon">
            <!-- Dental icon placeholder -->
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 5.5V7H9V5.5L3 7V9L5 9.5V15.5L3 16V18L9 16.5V18H15V16.5L21 18V16L19 15.5V9.5L21 9Z" fill="white"/>
            </svg>
          </div>
          <span class="brand-text">Cabinet Dentaire</span>
        </div>
        <div class="role" id="userNameRole">Dentiste</div>
      </div>

      <nav class="menu" id="menu">
        <div class="menu-item active" data-page="dashboard">
          <span class="label">
            <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 13H11V3H3V13ZM3 21H11V15H3V21ZM13 21H21V11H13V21ZM13 3V9H21V3H13Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="text">Tableau de bord</span>
          </span>
          <span class="count" id="cntToday"></span>
        </div>
        <div class="menu-item" data-page="patients">
          <span class="label">
            <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 4C16 2.89 16.89 2 18 2C19.11 2 20 2.89 20 4C20 5.11 19.11 6 18 6C16.89 6 16 5.11 16 4ZM20 22V16H16V22H20ZM22 22H10V16H8V22H6V16H4.5V9.5C4.5 8.12 5.62 7 7 7H11C12.38 7 13.5 8.12 13.5 9.5V16H22V22ZM8 7C8 5.62 9.12 4.5 10.5 4.5C11.88 4.5 13 5.62 13 7C13 8.38 11.88 9.5 10.5 9.5C9.12 9.5 8 8.38 8 7Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="text">Patients</span>
          </span>
        </div>
        <div class="menu-item" data-page="consultations">
          <span class="label">
            <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM7 7H9V9H7V7ZM7 11H9V13H7V11ZM7 15H9V17H7V15ZM17 17H11V15H17V17ZM17 13H11V11H17V13ZM17 9H11V7H17V9Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="text">Consultations</span>
          </span>
        </div>
        <div class="menu-item" data-page="ordonnances">
          <span class="label">
            <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15H16V17H8V15ZM8 11H16V13H8V11Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="text">Ordonnances</span>
          </span>
        </div>
        <div class="menu-item" data-page="suivi">
          <span class="label">
            <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15H16V17H8V15ZM8 11H16V13H8V11Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="text">Suivi Documents</span>
          </span>
        </div>
        <div class="menu-item" data-page="settings">
          <span class="label">
            <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.14 12.94C19.18 12.64 19.2 12.33 19.2 12C19.2 11.67 19.18 11.36 19.14 11.06L21.16 9.44C21.34 9.3 21.38 9.04 21.26 9.84L19.36 5.8C19.24 5.6 19 5.54 18.8 5.62L16.5 6.68C16.06 6.38 15.58 6.12 15.08 5.92L14.8 3.46C14.78 3.24 14.6 3.06 14.38 3.06H9.62C9.4 3.06 9.22 3.24 9.2 3.46L8.92 5.92C8.42 6.12 7.94 6.38 7.5 6.68L5.2 5.62C5 5.54 4.76 5.6 4.64 5.8L2.74 8.84C2.62 9.04 2.66 9.3 2.84 9.44L4.86 11.06C4.82 11.36 4.8 11.67 4.8 12C4.8 12.33 4.82 12.64 4.86 12.94L2.84 14.56C2.66 14.7 2.62 14.96 2.74 15.16L4.64 18.2C4.76 18.4 5 18.46 5.2 18.38L7.5 17.32C7.94 17.62 8.42 17.88 8.92 18.08L9.2 20.54C9.22 20.76 9.4 20.94 9.62 20.94H14.38C14.6 20.94 14.78 20.76 14.8 20.54L15.08 18.08C15.58 17.88 16.06 17.62 16.5 17.32L18.8 18.38C19 18.46 19.24 18.4 19.36 18.2L21.26 15.16C21.38 14.96 21.34 14.7 21.16 14.56L19.14 12.94ZM12 15.6C10.14 15.6 8.62 14.08 8.62 12.22C8.62 10.36 10.14 8.84 12 8.84C13.86 8.84 15.38 10.36 15.38 12.22C15.38 14.08 13.86 15.6 12 15.6Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="text">Paramètres</span>
          </span>
        </div>
      </nav>

      <button id="logoutBtn" class="logout-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.58L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z" fill="currentColor"/>
        </svg>
        <span>Se déconnecter</span>
      </button>
      <div class="sidebar-footer small">Version 1.0 — Local</div>
    </aside>

    <main class="main">
      <section class="main-content">
        <div class="header">
          <div class="header-left">
            <div class="title" id="pageTitle">Tableau de bord</div>
            <div class="subtitle" id="pageSubtitle">Vue globale du jour</div>
          </div>
          <div class="controls">
            <button id="refreshBtn" class="btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
              </svg>
              Actualiser
            </button>
            <button id="newApptBtn" class="btn primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
              </svg>
              Nouveau RDV
            </button>
          </div>
        </div>

        <div class="content-area" id="contentArea">
          <!-- dynamic content here -->
        </div>
      </section>

      <aside class="right-panel">
        <div class="section-title">Recherche</div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Rechercher patient par nom..." />
          <button id="searchBtn" class="btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="currentColor"/>
            </svg>
          </button>
        </div>
        <div id="searchResult"></div>

        <div class="section-title" style="margin-top: 24px;">Raccourcis</div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button class="btn" id="goPatients">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 4C16 2.89 16.89 2 18 2C19.11 2 20 2.89 20 4C20 5.11 19.11 6 18 6C16.89 6 16 5.11 16 4ZM20 22V16H16V22H20ZM22 22H10V16H8V22H6V16H4.5V9.5C4.5 8.12 5.62 7 7 7H11C12.38 7 13.5 8.12 13.5 9.5V16H22V22ZM8 7C8 5.62 9.12 4.5 10.5 4.5C11.88 4.5 13 5.62 13 7C13 8.38 11.88 9.5 10.5 9.5C9.12 9.5 8 8.38 8 7Z" fill="currentColor"/>
            </svg>
            Aller aux Patients
          </button>
          <button class="btn" id="goConsult">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM7 7H9V9H7V7ZM7 11H9V13H7V11ZM7 15H9V17H7V15ZM17 17H11V15H17V17ZM17 13H11V11H17V13ZM17 9H11V7H17V9Z" fill="currentColor"/>
            </svg>
            Aller aux Consultations
          </button>
        </div>
      </aside>
    </main>
  </div>

  <div id="modalRoot" style="display:none;"></div>

  <!-- jsPDF for export (if needed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /**************************************************************************
     * Dentist frontend logic with Consultation Reference System
     **************************************************************************/

    // small helpers
    const $ = id => document.getElementById(id);
    const escapeHtml = s => { if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); };
    const todayISO = () => new Date().toISOString().split('T')[0];

    // Function to generate a random 5-digit reference
    function generateConsultationRef() {
      return Math.floor(10000 + Math.random() * 90000).toString();
    }

    // Function to copy consultation reference to clipboard
    function copyConsultationRef(ref) {
      if (!ref || ref === 'N/A') {
        alert('Aucune référence disponible');
        return;
      }
      
      navigator.clipboard.writeText(ref).then(() => {
        alert(`Référence "${ref}" copiée dans le presse-papier`);
      }).catch(err => {
        console.error('Erreur copie presse-papier:', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = ref;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert(`Référence "${ref}" copiée dans le presse-papier`);
      });
    }

    // Function to open consultation selector
    function openConsultationSelector() {
      const root = $('modalRoot');
      const selectorModal = document.createElement('div');
      selectorModal.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" style="max-width: 700px;">
            <h3>Sélectionner une Consultation</h3>
            <div style="max-height: 400px; overflow-y: auto;">
              <table class="table">
                <thead>
                  <tr>
                    <th>Référence</th>
                    <th>Patient</th>
                    <th>Motif</th>
                    <th>Date</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  ${consultationsCache.map(c => {
                    const p = patientsCache.find(x => x.IDP === c.IDP) || {};
                    return `
                      <tr>
                        <td><strong>${escapeHtml(c.consultation_ref || 'N/A')}</strong></td>
                        <td>${escapeHtml(p.Nom || '')} ${escapeHtml(p.Prenom || '')}</td>
                        <td>${escapeHtml(c.Motif || '')}</td>
                        <td>${escapeHtml(c.DateCreation ? new Date(c.DateCreation).toLocaleDateString() : 'N/A')}</td>
                        <td>
                          <button class="btn primary" onclick="selectConsultation('${c.consultation_ref || ''}')">
                            Sélectionner
                          </button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            <div class="actions">
              <button class="btn" onclick="closeModal()">Fermer</button>
            </div>
          </div>
        </div>
      `;
      
      root.appendChild(selectorModal);
    }

    // Function to select consultation and fill the reference
    function selectConsultation(ref) {
      const refInput = document.getElementById('o_ConsultRef');
      if (refInput) {
        refInput.value = ref;
      }
      closeModal();
    }

    // Keep caches
    let patientsCache = [];
    let apptsCache = [];
    let consultationsCache = [];
    let ordonnancesCache = [];
    let suiviCache = [];

    // Menu navigation
    document.addEventListener('DOMContentLoaded', async () => {
      // Auth check (doctor)
      const user = await window.electronAPI.getCurrentUser();
      if(!user || (user.Droit || '').toLowerCase() !== 'doctor'){
        alert('⛔ Accès refusé — vous devez être connecté comme doctor');
        window.location.replace('login.html');
        return;
      }
      $('userNameRole').textContent = (user.Nom || 'Dentiste') + ' — ' + (user.Droit || 'doctor');

      // wired events
      document.querySelectorAll('.menu-item').forEach(el => {
        el.addEventListener('click', () => {
          document.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('active'));
          el.classList.add('active');
          const page = el.dataset.page;
          navigateTo(page);
        });
      });

      $('logoutBtn').addEventListener('click', () => window.electronAPI.logout());
      $('refreshBtn').addEventListener('click', () => reloadCurrentPage());
      $('newApptBtn').addEventListener('click', () => openCreateApptModal());
      $('searchBtn').addEventListener('click', searchPatient);
      $('searchInput').addEventListener('keydown', e => { if(e.key==='Enter') searchPatient(); });
      $('goPatients').addEventListener('click', () => navigateTo('patients'));
      $('goConsult').addEventListener('click', () => navigateTo('consultations'));

      // initial load
      await loadAllCaches();
      navigateTo('dashboard');
    });

    async function loadAllCaches(){
      // load patients & consultations & ordonnances & suivi
      try{
        patientsCache = await window.electronAPI.getPatients() || [];
      }catch(e){ console.error('getPatients err',e); patientsCache = []; }

      try{
        consultationsCache = await window.electronAPI.getConsultations() || [];
      }catch(e){ console.error('getConsultations err',e); consultationsCache=[]; }

      try{
        ordonnancesCache = await window.electronAPI.getOrdonnances() || [];
      }catch(e){ console.error('getOrdonnances err',e); ordonnancesCache=[]; }

      try{
        suiviCache = await window.electronAPI.getSuiviDocs() || [];
      }catch(e){ console.error('getSuiviDocs err',e); suiviCache=[]; }

      await loadTodayAppointments();
    }

    async function loadTodayAppointments(){
      const today = todayISO();
      try{
        apptsCache = await window.electronAPI.getAppointments({ startDate: today, endDate: today }) || [];
      }catch(e){ console.error('getAppointments err',e); apptsCache = []; }
      $('cntToday').textContent = apptsCache.length ? ` (${apptsCache.length})` : '';
    }

    let currentPage = null;
    function navigateTo(page){
      currentPage = page;
      if(page==='dashboard') renderDashboard();
      else if(page==='patients') renderPatientsPage();
      else if(page==='consultations') renderConsultationsPage();
      else if(page==='ordonnances') renderOrdonnancesPage();
      else if(page==='suivi') renderSuiviPage();
      else if(page==='settings') renderSettings();
    }

    function reloadCurrentPage(){ loadAllCaches().then(()=> navigateTo(currentPage || 'dashboard')); }

    /* ===================== DASHBOARD (RDV du jour) ===================== */
    function renderDashboard(){
      $('pageTitle').textContent = 'Tableau de bord — Rendez-Vous du jour';
      $('pageSubtitle').textContent = `Liste des rendez-vous pour aujourd'hui — ${todayISO()}`;
      const area = $('contentArea');
      area.innerHTML = `
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-value">${apptsCache.length}</div>
            <div class="stat-label">Rendez-vous aujourd'hui</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${patientsCache.length}</div>
            <div class="stat-label">Patients enregistrés</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${consultationsCache.length}</div>
            <div class="stat-label">Consultations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${ordonnancesCache.length}</div>
            <div class="stat-label">Ordonnances</div>
          </div>
        </div>
        <h3 style="margin-bottom:16px">Rendez-vous — Aujourd'hui</h3>
        <div id="todayList" class="today-list"></div>
      `;

      const listDiv = $('todayList');
      if(!apptsCache.length){
        listDiv.innerHTML = `<div class="small muted">Aucun RDV pour aujourd'hui.</div>`;
        return;
      }
      // sort by time
      const sorted = [...apptsCache].sort((a,b) => (a.HeureRv||'') > (b.HeureRv||'') ? 1 : -1);
      listDiv.innerHTML = '';
      sorted.forEach(a => {
        const p = patientsCache.find(x=>x.IDP===a.IDP) || {};
        const apptEl = document.createElement('div');
        apptEl.className = 'appt-card';
    apptEl.innerHTML = `
  <div class="appt-time">${escapeHtml(a.HeureRv||'--:--')}</div>
  <div class="appt-meta">
    <div class="patient-name">${escapeHtml(a.NomPrenom || (p && p.Nom ? (p.Nom+' '+(p.Prenom||'')) : 'Patient'))}</div>
    <div class="patient-details">
      <div class="small muted">${escapeHtml((p && p.CIN) || a.CIN || '')}</div>
      <div class="small">${escapeHtml((p && p.Tel) || a.Email || '')}</div>
      <div style="margin-left:auto"><span class="pill">${escapeHtml(a.Statut||'Planifié')}</span></div>
    </div>
    <div class="small muted" style="margin-top:8px">${escapeHtml(a.TypePatient||'--')}</div>
  </div>
  <div class="appt-actions">
    <!-- Only show patient button if we have a valid IDP -->
    ${a.IDP ? `<button class="btn" onclick="openPatientDetailsFromAppt(${a.IDP})">Patient</button>` : ''}
    <button class="btn primary" onclick="openApptEdit(${a.IDRv})">Ouvrir</button>
  </div>
`;
        listDiv.appendChild(apptEl);
      });
    }
window.openPatientDetailsFromAppt = async function(idp) {
  try {
    console.log('Opening patient details for ID:', idp);
    
    if (idp === undefined || idp === null || idp === 'null') {
      alert('Patient introuvable (no id provided)');
      return;
    }

    const numId = Number(idp);
    if (Number.isNaN(numId)) {
      alert('Patient introuvable (invalid id)');
      return;
    }

    // FIX: Use the correct function that exists in your db.js
    const p = await window.electronAPI.getPatientForDoc(numId);

    if (!p) {
      alert('Patient introuvable');
      return;
    }

    console.log('Found patient:', p);
    openPatientDetailsModal(p);

  } catch (err) {
    console.error('Error opening patient details:', err);
    alert('Erreur lors de l\'ouverture du patient. Regarde la console.');
  }
};
    window.openApptEdit = async function(idrv){
      try{
        const appt = await window.electronAPI.getAppointment(Number(idrv));
        if(!appt){ alert('RDV introuvable'); return; }
        openApptModal(appt);
      }catch(e){ console.error(e); alert('Erreur getAppointment'); }
    };

    /* ===================== APPOINTMENTS modal create/edit ===================== */
    function openCreateApptModal(){
      openApptModal({ IDRv:null, IDP:null, DateRv: todayISO(), HeureRv: '09:00', Statut: 'Planifié', TypePatient:'Consultation', NomPrenom:'', Email:''});
    }

   function openApptModal(appt){
  const root = $('modalRoot');
  root.style.display = 'block';
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h3>${appt.IDRv? 'Modifier RDV':'Créer RDV'}</h3>

        <div class="form-row">
          <div class="form-col">
            <label>Date</label>
            <input type="date" id="m_DateRv" value="${escapeHtml(appt.DateRv||'')}" />
          </div>
          <div class="form-col">
            <label>CIN du Patient</label>
            <input type="text" id="m_CIN" value="${escapeHtml(appt.CIN||'')}" 
                   placeholder="Saisir CIN du patient" />
            <div class="small muted" id="cinInfo" style="margin-top: 4px;"></div>
          </div>
          <div class="form-col">
            <label>Heure</label>
            <input type="time" id="m_HeureRv" value="${escapeHtml(appt.HeureRv||'')}" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>Patient (Nom complet)</label>
            <input type="text" id="m_Patient" placeholder="Saisir nom complet du patient" value="${escapeHtml(appt.NomPrenom||'')}" />
            <div class="small muted" id="patientInfo" style="margin-top: 4px;"></div>
          </div>
          <div class="form-col">
            <label>Email</label>
            <input type="email" id="m_Email" value="${escapeHtml(appt.Email||'')}" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>Type</label>
            <select id="m_Type">
              <option ${appt.TypePatient==='Consultation'?'selected':''}>Consultation</option>
              <option ${appt.TypePatient==='Soins'?'selected':''}>Soins</option>
              <option ${appt.TypePatient==='Extraction'?'selected':''}>Extraction</option>
              <option ${appt.TypePatient==='Controle'?'selected':''}>Contrôle</option>
            </select>
          </div>
          <div class="form-col">
            <label>Statut</label>
            <select id="m_Statut">
              <option ${appt.Statut==='Planifié'?'selected':''}>Planifié</option>
              <option ${appt.Statut==='Confirmé'?'selected':''}>Confirmé</option>
              <option ${appt.Statut==='Annulé'?'selected':''}>Annulé</option>
            </select>
          </div>
        </div>

        <div class="actions">
          ${appt.IDRv? '<button id="delApptBtn" class="btn danger">Supprimer</button>' : ''}
          <button id="cancelApptBtn" class="btn">Annuler</button>
          <button id="saveApptBtn" class="btn primary">Enregistrer</button>
        </div>
      </div>
    </div>
  `;

  // Add patient lookup functionality
  const cinInput = root.querySelector('#m_CIN');
  const patientInput = root.querySelector('#m_Patient');
  const cinInfo = root.querySelector('#cinInfo');
  const patientInfo = root.querySelector('#patientInfo');

  let foundPatientId = null;

  // CIN lookup
  cinInput.addEventListener('input', async () => {
    const cin = cinInput.value.trim();
    if (cin.length > 2) {
      try {
        const patient = await window.electronAPI.getPatientByCIN(cin);
        if (patient) {
          cinInfo.innerHTML = `<span style="color: var(--success);">✓ Patient trouvé: ${escapeHtml(patient.Nom)} ${escapeHtml(patient.Prenom)}</span>`;
          patientInput.value = `${patient.Nom} ${patient.Prenom}`;
          foundPatientId = patient.IDP;
        } else {
          cinInfo.innerHTML = `<span style="color: var(--warning);">⚠ Patient non trouvé - nouveau patient sera créé</span>`;
          foundPatientId = null;
        }
      } catch (error) {
        cinInfo.innerHTML = `<span style="color: var(--danger);">Erreur de recherche</span>`;
        foundPatientId = null;
      }
    } else {
      cinInfo.innerHTML = '';
      foundPatientId = null;
    }
  });

  // Name lookup
  patientInput.addEventListener('input', async () => {
    const name = patientInput.value.trim();
    if (name.length > 3) {
      try {
        const patients = await window.electronAPI.getPatients();
        const found = patients.find(p => 
          `${p.Nom} ${p.Prenom}`.toLowerCase().includes(name.toLowerCase()) ||
          name.toLowerCase().includes(`${p.Nom} ${p.Prenom}`.toLowerCase())
        );
        if (found) {
          patientInfo.innerHTML = `<span style="color: var(--success);">✓ Patient trouvé: CIN ${escapeHtml(found.CIN)}</span>`;
          cinInput.value = found.CIN;
          foundPatientId = found.IDP;
        } else {
          patientInfo.innerHTML = `<span style="color: var(--warning);">⚠ Patient non trouvé</span>`;
          foundPatientId = null;
        }
      } catch (error) {
        patientInfo.innerHTML = `<span style="color: var(--danger);">Erreur de recherche</span>`;
        foundPatientId = null;
      }
    } else {
      patientInfo.innerHTML = '';
      foundPatientId = null;
    }
  });

  root.querySelector('#cancelApptBtn').onclick = closeModal;
  
  root.querySelector('#saveApptBtn').onclick = async () => {
    const cin = document.getElementById('m_CIN').value.trim();
    const nomPrenom = document.getElementById('m_Patient').value.trim();
    
    if (!cin && !nomPrenom) {
      alert('Veuillez saisir au moins le CIN ou le nom du patient');
      return;
    }

    const payload = {
      IDRv: appt.IDRv || null,
      CIN: cin,
      NomPrenom: nomPrenom,
      Email: document.getElementById('m_Email').value.trim(),
      TypePatient: document.getElementById('m_Type').value,
      Statut: document.getElementById('m_Statut').value,
      DateRv: document.getElementById('m_DateRv').value,
      HeureRv: document.getElementById('m_HeureRv').value,
    };

    // If we found a patient during lookup, include the IDP
    if (foundPatientId) {
      payload.IDP = foundPatientId;
    }

    console.log('Saving appointment with payload:', payload);

    try{
      if(payload.IDRv){
        await window.electronAPI.updateAppointment(payload);
        alert('RDV modifié.');
      }else{
        await window.electronAPI.createAppointment(payload);
        alert('RDV créé.');
      }
      closeModal();
      await loadTodayAppointments();
      navigateTo('dashboard');
    }catch(e){ 
      console.error('Erreur enregistre RDV:', e); 
      alert('Erreur enregistrement RDV: ' + e.message); 
    }
  };

  if(appt.IDRv){
    root.querySelector('#delApptBtn').onclick = async () => {
      if(!confirm('Supprimer ce RDV ?')) return;
      try{
        await window.electronAPI.deleteAppointment(Number(appt.IDRv));
        alert('RDV supprimé.');
        closeModal();
        await loadTodayAppointments();
        navigateTo('dashboard');
      }catch(e){ console.error(e); alert('Erreur suppression RDV'); }
    };
  }
}

    function closeModal(){
      const root = $('modalRoot');
      root.style.display = 'none';
      root.innerHTML = '';
    }

    /* ===================== PATIENTS ===================== */
    function renderPatientsPage(){
      $('pageTitle').textContent = 'Patients';
      $('pageSubtitle').textContent = 'Gérer la liste des patients';
      const area = $('contentArea');
      area.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h3>Patients</h3>
          <div>
            <button id="addPatientBtn" class="btn primary">+ Ajouter Patient</button>
          </div>
        </div>
        <div style="overflow:auto">
          <table class="table" id="patientsTable">
            <thead><tr><th>Nom</th><th>Prénom</th><th>CIN</th><th>Téléphone</th><th>Ville</th><th>Actions</th></tr></thead>
            <tbody id="patientsTbody"></tbody>
          </table>
        </div>
      `;
      renderPatientsTable();
      document.getElementById('addPatientBtn').addEventListener('click', () => openPatientModal());
    }

    function renderPatientsTable(){
      const tbody = $('patientsTbody');
      const list = patientsCache || [];
      if(!list.length){ tbody.innerHTML = `<tr><td colspan="6" class="small muted">Aucun patient</td></tr>`; return; }
      tbody.innerHTML = list.map(p => `
        <tr>
          <td>${escapeHtml(p.Nom||'')}</td>
          <td>${escapeHtml(p.Prenom||'')}</td>
          <td>${escapeHtml(p.CIN||'')}</td>
          <td>${escapeHtml(p.Tel||'')}</td>
          <td>${escapeHtml(p.Ville||'')}</td>
          <td>
            <button class="btn" onclick="openPatientDetailsModalById(${p.IDP})">Détails</button>
            <button class="btn" onclick="openPatientEditModal(${p.IDP})">Modifier</button>
          </td>
        </tr>
      `).join('');
    }

    window.openPatientDetailsModalById = async function(idp){
      const list = await window.electronAPI.getPatients();
      const p = list.find(x=>x.IDP===idp);
      openPatientDetailsModal(p);
    }

    function openPatientDetailsModal(p){
      if(!p) return alert('Patient introuvable');
      const root = $('modalRoot'); root.style.display='block';
      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal">
            <h3>Détails Patient</h3>
            <div style="display:flex;gap:16px">
              <div style="flex:1">
                <p><strong>Nom:</strong> ${escapeHtml(p.Nom)}</p>
                <p><strong>Prénom:</strong> ${escapeHtml(p.Prenom)}</p>
                <p><strong>CIN:</strong> ${escapeHtml(p.CIN)}</p>
                <p><strong>Date Naissance:</strong> ${escapeHtml(p.DateNaissance)}</p>
                <p><strong>Télé:</strong> ${escapeHtml(p.Tel)}</p>
                <p><strong>Email:</strong> ${escapeHtml(p.Email)}</p>
                <p><strong>Adresse:</strong> ${escapeHtml(p.Adresse)}</p>
                <p><strong>Ville:</strong> ${escapeHtml(p.Ville)}</p>
              </div>
              <div style="flex:1">
                <p><strong>Allergies:</strong> ${escapeHtml(p.Allergies)}</p>
                <p><strong>Remarques:</strong> ${escapeHtml(p.Remarques)}</p>
              </div>
            </div>
            <div class="actions">
              <button id="closePatientBtn" class="btn">Fermer</button>
              <button id="exportPatientPdf" class="btn primary">Exporter PDF</button>
            </div>
          </div>
        </div>
      `;
      root.querySelector('#closePatientBtn').onclick = closeModal;
      root.querySelector('#exportPatientPdf').onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y=10;
        const addLine=(k,v)=>{ doc.text(`${k}: ${v||''}`, 10, y); y+=8; };
        addLine('Nom', p.Nom); addLine('Prénom', p.Prenom); addLine('CIN', p.CIN); addLine('DateNaissance', p.DateNaissance || '');
        addLine('Tel', p.Tel); addLine('Email', p.Email); addLine('Adresse', p.Adresse); addLine('Ville', p.Ville);
        addLine('Allergies', p.Allergies); addLine('Remarques', p.Remarques);
        doc.save(`${p.CIN || (p.Nom||'patient')}.pdf`);
      };
    }

    function openPatientModal(data = null){
      const isEdit = !!data;
      const patient = data || { Nom:'', Prenom:'', CIN:'', DateNaissance:'', Tel:'', Email:'', Adresse:'', Ville:'', Allergies:'', Remarques:'' };
      const root = $('modalRoot'); root.style.display='block';
      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal">
            <h3>${isEdit ? 'Modifier Patient' : 'Ajouter Patient'}</h3>
            <div class="form-row">
              <div class="form-col"><label>Nom</label><input id="p_Nom" type="text" value="${escapeHtml(patient.Nom||'')}" /></div>
              <div class="form-col"><label>Prénom</label><input id="p_Prenom" type="text" value="${escapeHtml(patient.Prenom||'')}" /></div>
            </div>
            <div class="form-row">
              <div class="form-col"><label>CIN</label><input id="p_CIN" type="text" value="${escapeHtml(patient.CIN||'')}" /></div>
              <div class="form-col"><label>Date Naissance</label><input id="p_DateNaissance" type="date" value="${escapeHtml(patient.DateNaissance||'')}" /></div>
            </div>
            <div class="form-row">
              <div class="form-col"><label>Téléphone</label><input id="p_Tel" type="text" value="${escapeHtml(patient.Tel||'')}" /></div>
              <div class="form-col"><label>Email</label><input id="p_Email" type="email" value="${escapeHtml(patient.Email||'')}" /></div>
            </div>
            <div class="form-row">
              <div class="form-col"><label>Adresse</label><input id="p_Adresse" type="text" value="${escapeHtml(patient.Adresse||'')}" /></div>
              <div class="form-col"><label>Ville</label><input id="p_Ville" type="text" value="${escapeHtml(patient.Ville||'')}" /></div>
            </div>
            <div class="form-row"><div class="form-col"><label>Allergies</label><textarea id="p_Allergies">${escapeHtml(patient.Allergies||'')}</textarea></div></div>
            <div class="form-row"><div class="form-col"><label>Remarques</label><textarea id="p_Remarques">${escapeHtml(patient.Remarques||'')}</textarea></div></div>
            <div class="actions">
              <button id="cancelPatient" class="btn">Annuler</button>
              <button id="savePatient" class="btn primary">${isEdit ? 'Sauvegarder' : 'Ajouter'}</button>
            </div>
          </div>
        </div>
      `;
      root.querySelector('#cancelPatient').onclick = closeModal;
      root.querySelector('#savePatient').onclick = async () => {
        const payload = {
          IDP: patient.IDP || undefined,
          Nom: document.getElementById('p_Nom').value.trim(),
          Prenom: document.getElementById('p_Prenom').value.trim(),
          CIN: document.getElementById('p_CIN').value.trim(),
          DateNaissance: document.getElementById('p_DateNaissance').value,
          Tel: document.getElementById('p_Tel').value.trim(),
          Email: document.getElementById('p_Email').value.trim(),
          Adresse: document.getElementById('p_Adresse').value.trim(),
          Ville: document.getElementById('p_Ville').value.trim(),
          Allergies: document.getElementById('p_Allergies').value.trim(),
          Remarques: document.getElementById('p_Remarques').value.trim()
        };
        try{
          if(isEdit){
            await window.electronAPI.updatePatient(payload);
            alert('Patient modifié.');
          }else{
            await window.electronAPI.addPatient(payload);
            alert('Patient ajouté.');
          }
          closeModal();
          patientsCache = await window.electronAPI.getPatients();
          renderPatientsTable();
        }catch(e){ console.error(e); alert('Erreur sauvegarde patient'); }
      };
    }

    window.openPatientEditModal = async function(idp){
      const list = await window.electronAPI.getPatients();
      const p = list.find(x=>x.IDP===idp);
      openPatientModal(p);
    };
/* ===================== CONSULTATIONS ===================== */
function renderConsultationsPage(){
  $('pageTitle').textContent = 'Consultations';
  $('pageSubtitle').textContent = 'Dossiers et consultations dentaires';
  const area = $('contentArea');
  area.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3>Consultations</h3>
      <div>
        <button id="addConsultBtn" class="btn primary">+ Nouvelle Consultation</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table class="table" id="consultTable">
        <thead><tr><th>ID</th><th>Référence</th><th>Patient</th><th>Motif</th><th>Diagnostic</th><th>Médecin</th><th>Actions</th></tr></thead>
        <tbody id="consultTbody"></tbody>
      </table>
    </div>
  `;
  renderConsultTable();
  document.getElementById('addConsultBtn').addEventListener('click', ()=> openConsultModal());
}

function renderConsultTable(){
  const tbody = $('consultTbody');
  const list = consultationsCache || [];
  if(!list.length){ tbody.innerHTML = `<tr><td colspan="7" class="small muted">Aucune consultation</td></tr>`; return; }
  tbody.innerHTML = list.map(c => {
    const p = patientsCache.find(x=>x.IDP===c.IDP) || {};
    return `<tr>
      <td>${c.IDC}</td>
      <td><strong>${escapeHtml(c.consultation_ref||'N/A')}</strong></td>
      <td>${escapeHtml(p.Nom||'') } ${escapeHtml(p.Prenom||'')}</td>
      <td>${escapeHtml(c.Motif||'')}</td>
      <td>${escapeHtml(c.Diagnostic||'')}</td>
      <td>${escapeHtml(c.NomMedecin||'')}</td>
      <td>
        <button class="btn" onclick="openConsultDetails(${c.IDC})">Voir</button>
        <button class="btn" onclick="openConsultEdit(${c.IDC})">Modifier</button>
        <button class="btn danger" onclick="deleteConsultation(${c.IDC})">Supprimer</button>
        <button class="btn primary" onclick="copyConsultationRef('${c.consultation_ref||''}')">Copier Réf</button>
      </td>
    </tr>`;
  }).join('');
}

function openConsultModal(data=null){
  const isEdit = !!data;
  const consult = data || { 
    IDC:null, 
    IDP:null, 
    CIN:'', 
    Motif:'', 
    Diagnostic:'', 
    Observations:'', 
    Remarques:'', 
    NomMedecin:'', 
    PiècesJointes_FileName:'',
    consultation_ref: data ? data.consultation_ref : generateConsultationRef()
  };
  
  const root = $('modalRoot'); root.style.display='block';
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>${isEdit? 'Modifier Consultation' : 'Nouvelle Consultation'}</h3>
        
        <!-- Add the reference field display -->
        <div class="form-row">
          <div class="form-col">
            <label>Référence Consultation</label>
            <input id="c_Ref" type="text" value="${escapeHtml(consult.consultation_ref||'')}" readonly 
                   style="background:#f0f0f0; font-weight:bold; color:var(--accent)" />
            <div class="small muted">Cette référence sera utilisée pour lier les ordonnances</div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <label>CIN du Patient *</label>
            <input id="c_CIN" type="text" value="${escapeHtml(consult.CIN||'')}" 
                   placeholder="Saisir le CIN du patient" />
            <div class="small muted" id="cinPatientInfo" style="margin-top: 4px;"></div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-col"><label>Motif</label><input id="c_Motif" type="text" value="${escapeHtml(consult.Motif||'')}" /></div>
          <div class="form-col"><label>Diagnostic</label><input id="c_Diagnostic" type="text" value="${escapeHtml(consult.Diagnostic||'')}" /></div>
        </div>
        <div class="form-row">
          <div class="form-col"><label>Observations</label><textarea id="c_Observations">${escapeHtml(consult.Observations||'')}</textarea></div>
        </div>
        <div class="form-row">
          <div class="form-col"><label>Nom Médecin</label><input id="c_NomMed" type="text" value="${escapeHtml(consult.NomMedecin||'')}" /></div>
          <div class="form-col"><label>Pièce jointe (jpg/png/pdf)</label><input id="c_File" type="file" /></div>
        </div>
        <div class="actions">
          ${isEdit? '<button id="delConsultBtn" class="btn danger">Supprimer</button>':''}
          <button id="cancelConsult" class="btn">Annuler</button>
          <button id="saveConsult" class="btn primary">${isEdit? 'Sauvegarder' : 'Enregistrer'}</button>
        </div>
      </div>
    </div>
  `;

  // Add live CIN search functionality
  const cinInput = root.querySelector('#c_CIN');
  const patientInfo = root.querySelector('#cinPatientInfo');
  
  cinInput.addEventListener('input', async () => {
    const cin = cinInput.value.trim();
    if (cin.length > 3) {
      try {
        const patient = await window.electronAPI.getPatientByCIN(cin);
        if (patient) {
          patientInfo.innerHTML = `<span style="color: var(--success);">✓ Patient trouvé: ${escapeHtml(patient.Nom)} ${escapeHtml(patient.Prenom)}</span>`;
        } else {
          patientInfo.innerHTML = `<span style="color: var(--warning);">⚠ Patient non trouvé - vérifiez le CIN</span>`;
        }
      } catch (error) {
        patientInfo.innerHTML = `<span style="color: var(--danger);">Erreur de recherche</span>`;
      }
    } else {
      patientInfo.innerHTML = '';
    }
  });

  // If editing and CIN exists, show patient info immediately
  if (isEdit && consult.CIN) {
    window.electronAPI.getPatientByCIN(consult.CIN).then(patient => {
      if (patient) {
        patientInfo.innerHTML = `<span style="color: var(--success);">Patient: ${escapeHtml(patient.Nom)} ${escapeHtml(patient.Prenom)}</span>`;
      }
    });
  }

  root.querySelector('#cancelConsult').onclick = closeModal;

  root.querySelector('#saveConsult').onclick = async () => {
    try {
      const cin = document.getElementById('c_CIN').value.trim();
      if(!cin) return alert('Veuillez saisir le CIN du patient.');

      const patient = await window.electronAPI.getPatientByCIN(cin);
      if(!patient) return alert('Patient introuvable. Vérifiez le CIN.');

      const payload = {
        IDC: consult.IDC || undefined,
        IDP: patient.IDP,
        CIN: cin,
        Motif: document.getElementById('c_Motif').value.trim(),
        Diagnostic: document.getElementById('c_Diagnostic').value.trim(),
        Observations: document.getElementById('c_Observations').value.trim(),
        Remarques: consult.Remarques || '',
        NomMedecin: document.getElementById('c_NomMed').value.trim(),
        consultation_ref: document.getElementById('c_Ref').value.trim() || generateConsultationRef(),
        PiècesJointes_FileName: consult.PiècesJointes_FileName || '',
        PiècesJointes_FileType: consult.PiècesJointes_FileType || '',
        PiècesJointes_FileData: null
      };

      const finput = document.getElementById('c_File');
      if(finput && finput.files && finput.files[0]){
        const file = finput.files[0];
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          payload.PiècesJointes_FileData = base64;
          payload.PiècesJointes_FileName = file.name;
          payload.PiècesJointes_FileType = file.type;
          if(consult.PiècesJointes_FileName) payload.OldFileName = consult.PiècesJointes_FileName;
          await saveConsultation(payload, isEdit);
        };
        reader.readAsDataURL(file);
      } else {
        await saveConsultation(payload, isEdit);
      }

    } catch (err) {
      console.error(err);
      alert('Erreur lors de la sauvegarde.');
    }
  };

  if(isEdit){
    root.querySelector('#delConsultBtn').onclick = async () => {
      if(!confirm('Supprimer cette consultation ?')) return;
      try{ 
        await window.electronAPI.deleteConsultation(Number(consult.IDC)); 
        alert('Supprimé'); 
        closeModal(); 
        consultationsCache = await window.electronAPI.getConsultations(); 
        renderConsultTable(); 
      }
      catch(e){ console.error(e); alert('Erreur suppression') }
    };
  }
}

async function saveConsultation(payload, isEdit){
  try{
    if(isEdit) {
      await window.electronAPI.updateConsultation(payload);
      alert('Consultation modifiée.');
    } else {
      await window.electronAPI.addConsultation(payload);
      alert('Consultation ajoutée. Référence: ' + payload.consultation_ref);
    }
    closeModal();
    consultationsCache = await window.electronAPI.getConsultations();
    renderConsultTable();
  }catch(e){ console.error(e); alert('Erreur enregistrement consultation'); }
}

window.openConsultEdit = async function(IDC){
  try {
    const consult = await window.electronAPI.getConsultationById(Number(IDC));
    if(!consult){
      alert("Consultation introuvable");
      return;
    }
    // Make sure the consultation_ref is included
    if (!consult.consultation_ref) {
      consult.consultation_ref = generateConsultationRef();
    }
    openConsultModal(consult);
  } catch (err) {
    console.error("openConsultEdit error:", err);
    alert("Erreur lors de la récupération de la consultation.");
  }
};

window.openConsultDetails = async function(IDC){
  const consult = await window.electronAPI.getConsultationById(Number(IDC));
  if(!consult) return alert('Consultation introuvable');

  const p = patientsCache.find(x=>x.IDP===consult.IDP) || {};
  const root = $('modalRoot'); 
  root.style.display='block';

  let previewHTML = '<div class="small muted">Aucun fichier</div>';
  const fileName = consult['PiècesJointes_FileName'];
  
  async function getFilePreview() {
    try {
      if (!fileName) {
        return '<div class="small muted">Aucun fichier joint</div>';
      }

      const fileInfo = await window.electronAPI.getConsultationFile(fileName);
      
      if (!fileInfo.exists) {
        return `<div class="small muted">Fichier non trouvé: ${escapeHtml(fileName)}</div>`;
      }

      const fileUrl = fileInfo.url;
      const fileExtension = fileInfo.extension.toLowerCase();

      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
        return `
          <div class="image-preview">
            <img src="${fileUrl}" 
                 style="max-width:100%; max-height:250px; border:1px solid #ccc; border-radius:6px; margin-top:6px" 
                 alt="${escapeHtml(fileName)}" />
          </div>
        `;
      } 
      else if (fileExtension === 'pdf') {
        return `
          <div class="pdf-preview">
            <iframe src="${fileUrl}" 
                    style="width:100%; height:350px; border:1px solid #ccc; border-radius:6px; margin-top:6px"
                    title="PDF Preview"></iframe>
          </div>
        `;
      }
      else if (['doc', 'docx', 'rtf'].includes(fileExtension)) {
        return `
          <div class="document-preview">
            <p class="small muted">Document Word - ${escapeHtml(fileName)}</p>
            <div style="display:flex; gap:10px; margin-top:6px;">
              <a href="${fileUrl}" download="${escapeHtml(fileName)}" 
                 class="btn primary" style="text-decoration:none;">
                📥 Télécharger
              </a>
              <a href="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(fileUrl)}" 
                 target="_blank" class="btn" style="text-decoration:none;">
                👁️ Prévisualiser en ligne
              </a>
            </div>
          </div>
        `;
      }
      else if (['xls', 'xlsx', 'csv'].includes(fileExtension)) {
        return `
          <div class="spreadsheet-preview">
            <p class="small muted">Feuille de calcul - ${escapeHtml(fileName)}</p>
            <div style="display:flex; gap:10px; margin-top:6px;">
              <a href="${fileUrl}" download="${escapeHtml(fileName)}" 
                 class="btn primary" style="text-decoration:none;">
                📥 Télécharger
              </a>
              <a href="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(fileUrl)}" 
                 target="_blank" class="btn" style="text-decoration:none;">
                👁️ Prévisualiser en ligne
              </a>
            </div>
          </div>
        `;
      }
      else if (['ppt', 'pptx'].includes(fileExtension)) {
        return `
          <div class="presentation-preview">
            <p class="small muted">Présentation - ${escapeHtml(fileName)}</p>
            <div style="display:flex; gap:10px; margin-top:6px;">
              <a href="${fileUrl}" download="${escapeHtml(fileName)}" 
                 class="btn primary" style="text-decoration:none;">
                📥 Télécharger
              </a>
              <a href="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(fileUrl)}" 
                 target="_blank" class="btn" style="text-decoration:none;">
                👁️ Prévisualiser en ligne
              </a>
            </div>
          </div>
        `;
      }
      else if (fileExtension === 'txt') {
        return `
          <div class="text-preview">
            <a href="${fileUrl}" download="${escapeHtml(fileName)}" 
               class="file-item" style="display:inline-block; margin-bottom:8px;">
              📄 ${escapeHtml(fileName)} (Télécharger)
            </a>
            <div id="textContent" 
                 style="width:100%; height:200px; border:1px solid #ccc; border-radius:6px; padding:8px; overflow:auto; background:#f9f9f9; font-family:monospace; white-space:pre-wrap;">
              Chargement du contenu...
            </div>
          </div>
        `;
      }
      else {
        return `
          <div class="generic-file">
            <p class="small muted">Fichier: ${escapeHtml(fileName)}</p>
            <a href="${fileUrl}" download="${escapeHtml(fileName)}" 
               class="btn primary" style="text-decoration:none; display:inline-block; margin-top:6px">
              📥 Télécharger le fichier
            </a>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading file:', error);
      return '<div class="small muted text-error">Erreur de chargement du fichier</div>';
    }
  }

  previewHTML = '<div class="small muted">Chargement du fichier...</div>';
  
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal" style="max-width:800px;">
        <h3>Consultation #${consult.IDC}</h3>

        <!-- Add reference display -->
        <div style="background:var(--accent-light); padding:12px; border-radius:6px; margin-bottom:16px;">
          <strong>Référence Consultation:</strong> 
          <span style="font-size:18px; font-weight:bold; color:var(--accent-dark)">${escapeHtml(consult.consultation_ref||'N/A')}</span>
          <button class="btn" onclick="copyConsultationRef('${consult.consultation_ref||''}')" 
                  style="margin-left:12px; padding:4px 8px; font-size:12px;">
            📋 Copier
          </button>
        </div>

        <p><strong>Patient :</strong> ${escapeHtml(p.Nom||'')} ${escapeHtml(p.Prenom||'')} (CIN: ${p.CIN || 'N/A'})</p>
        <p><strong>Motif :</strong> ${escapeHtml(consult.Motif)}</p>
        <p><strong>Diagnostic :</strong> ${escapeHtml(consult.Diagnostic)}</p>
        <p><strong>Observations :</strong> ${escapeHtml(consult.Observations)}</p>
        <p><strong>Remarques :</strong> ${escapeHtml(consult.Remarques)}</p>

        <div style="margin-top:12px">
          <strong>Pièce jointe :</strong>
          <div class="file-preview">
            ${previewHTML}
          </div>
        </div>

        <div class="actions" style="margin-top:15px">
          <button id="closeConsult" class="btn">Fermer</button>
          <button id="printConsult" class="btn primary">Imprimer / Export</button>
        </div>
      </div>
    </div>
  `;

  if (fileName) {
    getFilePreview().then(html => {
      const previewContainer = root.querySelector('.file-preview');
      if (previewContainer) {
        previewContainer.innerHTML = html;
        
        const textContentEl = previewContainer.querySelector('#textContent');
        if (textContentEl) {
          const downloadLink = previewContainer.querySelector('a[download]');
          if (downloadLink) {
            fetch(downloadLink.href)
              .then(r => r.text())
              .then(text => {
                textContentEl.textContent = text.substring(0, 5000) + (text.length > 5000 ? '... (tronqué)' : '');
              })
              .catch(err => {
                textContentEl.textContent = 'Erreur de chargement: ' + err.message;
              });
          }
        }
      }
    });
  }

  root.querySelector('#closeConsult').onclick = closeModal;

  root.querySelector('#printConsult').onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y=10;

    const addLine=(k,v)=>{
      const lines = doc.splitTextToSize(`${k}: ${v||''}`, 180);
      lines.forEach(line => {
        if (y > 280) { doc.addPage(); y=10; }
        doc.text(line, 10, y);
        y+=8;
      });
    };

    doc.setFontSize(16);
    doc.text(`Consultation #${consult.IDC}`, 10, y);
    y+=12;
    doc.setFontSize(12);

    addLine('Référence', consult.consultation_ref || 'N/A');
    addLine('Patient', p.Nom + ' ' + p.Prenom);
    addLine('CIN', p.CIN || 'N/A');
    addLine('Motif', consult.Motif);
    addLine('Diagnostic', consult.Diagnostic);
    addLine('Observations', consult.Observations);
    addLine('Remarques', consult.Remarques);
    
    if (fileName) {
      addLine('Fichier joint', fileName);
    }

    doc.save(`consultation_${consult.IDC}.pdf`);
  };
};

async function deleteConsultation(IDC){
  if(!confirm('Supprimer la consultation ?')) return;
  try{ await window.electronAPI.deleteConsultation(Number(IDC)); consultationsCache = await window.electronAPI.getConsultations(); renderConsultTable(); alert('Supprimé'); }
  catch(e){ console.error(e); alert('Erreur suppression'); }
}

/* ===================== ORDONNANCES ===================== */
function renderOrdonnancesPage(){
  $('pageTitle').textContent = 'Ordonnances';
  $('pageSubtitle').textContent = 'Gestion des ordonnances - Utilisez le CIN du patient';
  const area = $('contentArea');
  area.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3>Ordonnances</h3>
      <div><button id="addOrdoBtn" class="btn primary">+ Nouvelle Ordonnance</button></div>
    </div>
    <div style="overflow:auto">
      <table class="table" id="ordonnTable">
        <thead><tr><th>ID</th><th>Patient</th><th>CIN</th><th>Médecin</th><th>Médicaments</th><th>Date</th><th>Référence Consultation</th><th>Actions</th></tr></thead>
        <tbody id="ordonnTbody"></tbody>
      </table>
    </div>
  `;
  renderOrdonnancesTable();
  document.getElementById('addOrdoBtn').addEventListener('click', ()=> openOrdonnanceModal());
}

function renderOrdonnancesTable(){
  const tbody = $('ordonnTbody');
  const list = ordonnancesCache || [];
  if(!list.length){ tbody.innerHTML = `<tr><td colspan="8" class="small muted">Aucune ordonnance</td></tr>`; return; }
  
  const renderPromises = list.map(async (o) => {
    const c = consultationsCache.find(x=>x.IDC===o.IDC) || {};
    const p = patientsCache.find(x=>x.IDP===o.IDP) || {};
    const meds = [o.Medicament1,o.Medicament2,o.Medicament3].filter(Boolean);
    const medsText = meds.length > 0 ? meds.join(', ') : 'Aucun médicament';
    
    return `<tr>
      <td>${o.IDR}</td>
      <td>${escapeHtml(p.Nom||'')} ${escapeHtml(p.Prenom||'')}</td>
      <td>${escapeHtml(p.CIN||'')}</td>
      <td>${escapeHtml(c.NomMedecin||'Non spécifié')}</td>
      <td>${escapeHtml(medsText)}</td>
      <td>${escapeHtml(c.DateCreation ? new Date(c.DateCreation).toLocaleDateString() : 'N/A')}</td>
      <td>
        <span class="pill">${escapeHtml(o.consultation_ref || 'Non liée')}</span>
      </td>
      <td>
        <button class="btn" onclick="openOrdonnanceDetails(${o.IDR})">Voir</button>
        <button class="btn" onclick="openOrdonnanceEdit(${o.IDR})">Modifier</button>
        <button class="btn danger" onclick="deleteOrdonnance(${o.IDR})">Supprimer</button>
      </td>
    </tr>`;
  });

  Promise.all(renderPromises).then(rows => {
    tbody.innerHTML = rows.join('');
  });
}

function openOrdonnanceModal(data = null){
  const isEdit = !!data;
  const user = window.electronAPI.getCurrentUser ? window.electronAPI.getCurrentUser() : { Nom: '', Prenom: '' };
  const doctorName = `${user.Nom || ''} ${user.Prenom || ''}`.trim() || 'Dr. Non spécifié';
  
  const o = data || { 
    IDR: null, 
    patientCIN: '', 
    medecinName: doctorName,
    consultation_ref: '',
    medications: [
      { medicament: '', posologie: '', duree: '' },
      { medicament: '', posologie: '', duree: '' },
      { medicament: '', posologie: '', duree: '' }
    ],
    Remarques: ''
  };

  // If editing, convert old format to new format
  if (isEdit && data) {
    o.medications = [];
    for (let i = 1; i <= 10; i++) {
      const med = data[`M${i}`] || data[`Medicament${i}`];
      const pos = data[`P${i}`] || data[`Posologie${i}`];
      const dur = data[`D${i}`] || data[`Duree${i}`];
      
      if (med || pos || dur) {
        o.medications.push({
          medicament: med || '',
          posologie: pos || '',
          duree: dur || ''
        });
      }
    }
    
    // Ensure we have at least 3 medication slots
    while (o.medications.length < 3) {
      o.medications.push({ medicament: '', posologie: '', duree: '' });
    }
  }

  const root = $('modalRoot'); 
  root.style.display = 'block';
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal" style="max-width: 900px;">
        <h3>${isEdit ? 'Modifier Ordonnance' : 'Nouvelle Ordonnance'}</h3>
        
        <!-- Add consultation reference field -->
        <div class="form-row">
          <div class="form-col">
            <label>Référence Consultation (optionnel)</label>
            <input id="o_ConsultRef" type="text" value="${escapeHtml(o.consultation_ref || '')}" 
                   placeholder="Saisir la référence de consultation" />
            <div class="small muted">Collez la référence de la consultation pour lier l'ordonnance</div>
          </div>
          <div class="form-col">
            <label>Rechercher Consultation</label>
            <button type="button" class="btn" onclick="openConsultationSelector()" style="width:100%">
              🔍 Choisir une Consultation
            </button>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <label>CIN du Patient *</label>
            <input id="o_CIN" type="text" value="${escapeHtml(o.patientCIN || '')}" 
                   placeholder="Saisir le CIN du patient" 
                   ${isEdit ? 'readonly' : ''} />
            <div class="small muted" id="patientInfo" style="margin-top: 4px;"></div>
          </div>
          <div class="form-col">
            <label>Médecin prescripteur *</label>
            <input id="o_Medecin" type="text" value="${escapeHtml(o.medecinName || doctorName)}" />
          </div>
        </div>

        <div id="medicationsContainer">
          ${o.medications.map((med, index) => `
            <div class="medication-section" data-index="${index}">
              <div class="medication-header">
                <strong style="color: var(--accent);">Médicament ${index + 1}</strong>
                ${index >= 3 ? `
                  <button type="button" class="remove-medication-btn" onclick="removeMedication(${index})">×</button>
                ` : ''}
              </div>
              <div class="medication-fields">
                <div class="form-col">
                  <input type="text" id="o_Med${index+1}" placeholder="Nom du médicament" 
                         value="${escapeHtml(med.medicament)}" />
                </div>
                <div class="form-col">
                  <input type="text" id="o_Pos${index+1}" placeholder="Posologie" 
                         value="${escapeHtml(med.posologie)}" />
                </div>
                <div class="form-col">
                  <input type="text" id="o_Dur${index+1}" placeholder="Durée du traitement" 
                         value="${escapeHtml(med.duree)}" />
                </div>
                ${index >= 3 ? '<div class="form-col"></div>' : ''}
              </div>
            </div>
          `).join('')}
        </div>

        <div style="text-align: center; margin: 16px 0;">
          <button type="button" class="btn" onclick="addMedication()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
            </svg>
            Ajouter un médicament
          </button>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>Remarques et instructions</label>
            <textarea id="o_Rem" placeholder="Instructions supplémentaires..." style="min-height: 80px;">${escapeHtml(o.Remarques || '')}</textarea>
          </div>
        </div>

        <div class="actions">
          ${isEdit ? '<button id="delOrdoBtn" class="btn danger">Supprimer</button>' : ''}
          <button id="cancelOrdo" class="btn">Annuler</button>
          <button id="saveOrdo" class="btn primary">${isEdit ? 'Sauvegarder' : 'Enregistrer l\'ordonnance'}</button>
        </div>
      </div>
    </div>
  `;

  const cinInput = root.querySelector('#o_CIN');
  const patientInfo = root.querySelector('#patientInfo');
  
  if (!isEdit) {
    cinInput.addEventListener('input', async () => {
      const cin = cinInput.value.trim();
      if (cin.length > 3) {
        try {
          const patient = await window.electronAPI.getPatientByCIN(cin);
          if (patient) {
            patientInfo.innerHTML = `<span style="color: var(--success);">✓ Patient trouvé: ${escapeHtml(patient.Nom)} ${escapeHtml(patient.Prenom)}</span>`;
          } else {
            patientInfo.innerHTML = `<span style="color: var(--warning);">⚠ Patient non trouvé - une nouvelle consultation sera créée</span>`;
          }
        } catch (error) {
          patientInfo.innerHTML = `<span style="color: var(--danger);">Erreur de recherche</span>`;
        }
      } else {
        patientInfo.innerHTML = '';
      }
    });
  } else {
    if (o.patientCIN) {
      window.electronAPI.getPatientByCIN(o.patientCIN).then(patient => {
        if (patient) {
          patientInfo.innerHTML = `<span style="color: var(--success);">Patient: ${escapeHtml(patient.Nom)} ${escapeHtml(patient.Prenom)}</span>`;
        }
      });
    }
  }

  root.querySelector('#cancelOrdo').onclick = closeModal;
  
  root.querySelector('#saveOrdo').onclick = async () => {
    const cin = document.getElementById('o_CIN').value.trim();
    const medecinName = document.getElementById('o_Medecin').value.trim();
    const consultationRef = document.getElementById('o_ConsultRef').value.trim();
    
    if (!cin) {
      alert('Veuillez saisir le CIN du patient');
      return;
    }
    
    if (!medecinName) {
      alert('Veuillez saisir le nom du médecin prescripteur');
      return;
    }

    // Collect medications
    const medications = [];
    const medicationSections = root.querySelectorAll('.medication-section');
    
    medicationSections.forEach((section, index) => {
      const medicament = document.getElementById(`o_Med${index+1}`).value.trim();
      const posologie = document.getElementById(`o_Pos${index+1}`).value.trim();
      const duree = document.getElementById(`o_Dur${index+1}`).value.trim();
      
      if (medicament || posologie || duree) {
        medications.push({
          medicament,
          posologie,
          duree
        });
      }
    });

    if (medications.length === 0) {
      alert('Veuillez saisir au moins un médicament');
      return;
    }

    // Convert medications to the format expected by the database
    const medPayload = {};
    medications.forEach((med, index) => {
      medPayload[`M${index+1}`] = med.medicament;
      medPayload[`P${index+1}`] = med.posologie;
      medPayload[`D${index+1}`] = med.duree;
    });

    const payload = {
      IDR: o.IDR || undefined,
      patientCIN: cin,
      medecinName: medecinName,
      consultation_ref: consultationRef,
      Remarques: document.getElementById('o_Rem').value.trim(),
      ...medPayload
    };

    try {
      if (isEdit) {
        await window.electronAPI.updateOrdonnanceByCIN(payload);
        alert('Ordonnance modifiée avec succès.');
      } else {
        const result = await window.electronAPI.addOrdonnanceByCIN(payload);
        alert(`Ordonnance créée avec succès (ID: ${result.IDR})`);
      }
      closeModal();
      ordonnancesCache = await window.electronAPI.getOrdonnances();
      renderOrdonnancesTable();
    } catch (error) {
      console.error('Erreur ordonnance:', error);
      alert('Erreur: ' + (error.message || 'Impossible de sauvegarder l\'ordonnance'));
    }
  };

  if (isEdit) {
    root.querySelector('#delOrdoBtn').onclick = async () => {
      if (!confirm('Supprimer cette ordonnance ?')) return;
      try {
        await window.electronAPI.deleteOrdonnance(Number(o.IDR));
        ordonnancesCache = await window.electronAPI.getOrdonnances();
        renderOrdonnancesTable();
        closeModal();
        alert('Ordonnance supprimée');
      } catch (error) {
        console.error(error);
        alert('Erreur lors de la suppression');
      }
    };
  }
}

// Function to add a new medication field
window.addMedication = function() {
  const container = document.getElementById('medicationsContainer');
  const currentCount = container.querySelectorAll('.medication-section').length;
  
  const newIndex = currentCount;
  const newSection = document.createElement('div');
  newSection.className = 'medication-section';
  newSection.setAttribute('data-index', newIndex);
  newSection.innerHTML = `
    <div class="medication-header">
      <strong style="color: var(--accent);">Médicament ${newIndex + 1}</strong>
      <button type="button" class="remove-medication-btn" onclick="removeMedication(${newIndex})">×</button>
    </div>
    <div class="medication-fields">
      <div class="form-col">
        <input type="text" id="o_Med${newIndex+1}" placeholder="Nom du médicament" />
      </div>
      <div class="form-col">
        <input type="text" id="o_Pos${newIndex+1}" placeholder="Posologie" />
      </div>
      <div class="form-col">
        <input type="text" id="o_Dur${newIndex+1}" placeholder="Durée du traitement" />
      </div>
      <div class="form-col"></div>
    </div>
  `;
  
  container.appendChild(newSection);
};

// Function to remove a medication field
window.removeMedication = function(index) {
  const section = document.querySelector(`.medication-section[data-index="${index}"]`);
  if (section) {
    section.remove();
    
    // Re-index remaining sections
    const remainingSections = document.querySelectorAll('.medication-section');
    remainingSections.forEach((section, newIndex) => {
      section.setAttribute('data-index', newIndex);
      const header = section.querySelector('.medication-header strong');
      header.textContent = `Médicament ${newIndex + 1}`;
      
      // Update IDs of input fields
      const medicamentInput = section.querySelector('input[type="text"]:nth-child(1)');
      const posologieInput = section.querySelector('input[type="text"]:nth-child(2)');
      const dureeInput = section.querySelector('input[type="text"]:nth-child(3)');
      
      if (medicamentInput) medicamentInput.id = `o_Med${newIndex+1}`;
      if (posologieInput) posologieInput.id = `o_Pos${newIndex+1}`;
      if (dureeInput) dureeInput.id = `o_Dur${newIndex+1}`;
      
      // Update remove button onclick
      const removeButtons = section.querySelectorAll('.remove-medication-btn');
      removeButtons.forEach(btn => {
        btn.setAttribute('onclick', `removeMedication(${newIndex})`);
      });
    });
  }
};

// Add consultation selector function
window.openConsultationSelector = function() {
  const root = $('modalRoot');
  const currentModal = root.querySelector('.modal-backdrop');
  
  if (!currentModal) return;
  
  // Create consultation selector modal
  const selectorModal = document.createElement('div');
  selectorModal.className = 'modal-backdrop';
  selectorModal.style.zIndex = '10001';
  selectorModal.innerHTML = `
    <div class="modal" style="max-width: 800px;">
      <h3>Sélectionner une Consultation</h3>
      <div style="margin-bottom: 16px;">
        <input type="text" id="consultSearch" placeholder="Rechercher par référence, patient..." 
               style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Référence</th>
              <th>Patient</th>
              <th>Date</th>
              <th>Médecin</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="consultSelectorBody">
            ${consultationsCache.map(c => {
              const p = patientsCache.find(x => x.IDP === c.IDP) || {};
              return `
                <tr>
                  <td><strong>${escapeHtml(c.consultation_ref || 'N/A')}</strong></td>
                  <td>${escapeHtml(p.Nom || '')} ${escapeHtml(p.Prenom || '')}</td>
                  <td>${c.DateCreation ? new Date(c.DateCreation).toLocaleDateString() : 'N/A'}</td>
                  <td>${escapeHtml(c.NomMedecin || '')}</td>
                  <td>
                    <button class="btn primary" onclick="selectConsultation('${escapeHtml(c.consultation_ref || '')}')">
                      Sélectionner
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
      <div class="actions" style="margin-top: 16px;">
        <button class="btn" onclick="closeConsultationSelector()">Annuler</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(selectorModal);
  
  // Add search functionality
  const searchInput = selectorModal.querySelector('#consultSearch');
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = selectorModal.querySelectorAll('#consultSelectorBody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
};

window.selectConsultation = function(consultRef) {
  const consultRefInput = document.getElementById('o_ConsultRef');
  if (consultRefInput) {
    consultRefInput.value = consultRef;
  }
  closeConsultationSelector();
};

window.closeConsultationSelector = function() {
  const selectorModal = document.querySelector('.modal-backdrop[style*="z-index: 10001"]');
  if (selectorModal) {
    selectorModal.remove();
  }
};

window.openOrdonnanceDetails = async function(IDR){
  const o = (await window.electronAPI.getOrdonnanceById(Number(IDR))) || null;
  if(!o) return alert('Ordonnance introuvable');
  
  const p = patientsCache.find(x=>x.IDP===o.IDP) || {};
  const c = consultationsCache.find(x=>x.IDC===o.IDC) || {};
  
  // Collect medications from both old and new formats
  const medications = [];
  for (let i = 1; i <= 10; i++) {
    const med = o[`M${i}`] || o[`Medicament${i}`];
    const pos = o[`P${i}`] || o[`Posologie${i}`];
    const dur = o[`D${i}`] || o[`Duree${i}`];
    
    if (med || pos || dur) {
      medications.push({
        medicament: med,
        posologie: pos,
        duree: dur
      });
    }
  }
  
  const root = $('modalRoot'); 
  root.style.display='block';
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>Ordonnance #${o.IDR}</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
          <div>
            <p><strong>Patient:</strong> ${escapeHtml(p.Nom||'')} ${escapeHtml(p.Prenom||'')}</p>
            <p><strong>CIN:</strong> ${escapeHtml(p.CIN||'')}</p>
            <p><strong>Médecin:</strong> ${escapeHtml(c.NomMedecin||'Non spécifié')}</p>
          </div>
          <div>
            <p><strong>Date consultation:</strong> ${escapeHtml(c.DateCreation ? new Date(c.DateCreation).toLocaleDateString() : 'N/A')}</p>
            <p><strong>N° Consultation:</strong> ${o.IDC || 'N/A'}</p>
            <p><strong>Référence Consultation:</strong> <span class="pill">${escapeHtml(o.consultation_ref || 'Non liée')}</span></p>
          </div>
        </div>

        <div style="margin: 16px 0;">
          <strong style="color: var(--accent); font-size: 16px;">Médicaments prescrits:</strong>
          <div style="margin-top: 12px;">
            ${medications.map((med, index) => `
              <div style="padding: 12px; background: #f8fafc; border-radius: 6px; margin-bottom: 8px;">
                <strong>${escapeHtml(med.medicament)}</strong><br>
                <span class="small">Posologie: ${escapeHtml(med.posologie)} - Durée: ${escapeHtml(med.duree)}</span>
              </div>
            `).join('')}
          </div>
        </div>

        ${o.Remarques ? `
          <div style="margin: 16px 0;">
            <strong>Remarques:</strong>
            <div style="padding: 12px; background: #f0f9ff; border-radius: 6px; margin-top: 8px;">
              ${escapeHtml(o.Remarques)}
            </div>
          </div>
        ` : ''}

        <div class="actions">
          <button id="closeOrdo" class="btn">Fermer</button>
          <button id="exportOrdoPdf" class="btn primary">Exporter PDF</button>
        </div>
      </div>
    </div>
  `;
  
  root.querySelector('#closeOrdo').onclick = closeModal;
  root.querySelector('#exportOrdoPdf').onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;
    
    doc.setFontSize(16);
    doc.text('ORDONNANCE MÉDICALE', 105, y, { align: 'center' });
    y += 15;
    
    doc.setFontSize(10);
    doc.text(`N°: ${o.IDR}`, 20, y);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, y);
    y += 10;
    
    if (o.consultation_ref) {
      doc.text(`Référence Consultation: ${o.consultation_ref}`, 20, y);
      y += 6;
    }
    
    doc.text(`Patient: ${p.Nom || ''} ${p.Prenom || ''}`, 20, y);
    y += 6;
    doc.text(`CIN: ${p.CIN || ''}`, 20, y);
    y += 6;
    doc.text(`Médecin: ${c.NomMedecin || ''}`, 20, y);
    y += 15;
    
    doc.setFontSize(12);
    doc.text('MÉDICAMENTS PRESCRITS:', 20, y);
    y += 10;
    
    doc.setFontSize(10);
    medications.forEach(med => {
      doc.text(`• ${med.medicament} - ${med.posologie} - ${med.duree}`, 25, y);
      y += 6;
    });
    
    y += 10;
    if (o.Remarques) {
      doc.text('Remarques:', 20, y);
      y += 6;
      const remarks = doc.splitTextToSize(o.Remarques, 170);
      remarks.forEach(line => {
        doc.text(line, 25, y);
        y += 6;
      });
    }
    
    y += 15;
    doc.text('Signature et cachet du médecin:', 20, y);
    y += 20;
    doc.line(20, y, 80, y);
    
    doc.save(`ordonnance_${o.IDR}_${p.CIN || 'patient'}.pdf`);
  };
};

window.openOrdonnanceEdit = async function(IDR){
  const o = await window.electronAPI.getOrdonnanceById(Number(IDR));
  if (!o) {
    alert('Ordonnance introuvable');
    return;
  }
  
  const p = patientsCache.find(x => x.IDP === o.IDP) || {};
  const c = consultationsCache.find(x => x.IDC === o.IDC);
  
  const ordonnanceData = {
    IDR: o.IDR,
    patientCIN: p.CIN || '',
    medecinName: c && c.NomMedecin ? c.NomMedecin : '',
    consultation_ref: o.consultation_ref || '',
    Remarques: o.Remarques || ''
  };
  
  // Convert old format to new format for medications
  ordonnanceData.medications = [];
  for (let i = 1; i <= 10; i++) {
    const med = o[`M${i}`] || o[`Medicament${i}`];
    const pos = o[`P${i}`] || o[`Posologie${i}`];
    const dur = o[`D${i}`] || o[`Duree${i}`];
    
    if (med || pos || dur) {
      ordonnanceData.medications.push({
        medicament: med || '',
        posologie: pos || '',
        duree: dur || ''
      });
    }
  }
  
  // Ensure we have at least 3 medication slots
  while (ordonnanceData.medications.length < 3) {
    ordonnanceData.medications.push({ medicament: '', posologie: '', duree: '' });
  }
  
  openOrdonnanceModal(ordonnanceData);
};

async function deleteOrdonnance(IDR){
  if(!confirm('Supprimer ordonnance ?')) return;
  try{ await window.electronAPI.deleteOrdonnance(Number(IDR)); ordonnancesCache = await window.electronAPI.getOrdonnances(); renderOrdonnancesTable(); alert('Supprimé'); }
  catch(e){ console.error(e); alert('Erreur suppression'); }
}
    /* ===================== SUIVI DOCUMENTS ===================== */
    function renderSuiviPage(){
      $('pageTitle').textContent = 'Suivi Documents';
      $('pageSubtitle').textContent = 'Gestion des documents et justificatifs';
      const area = $('contentArea');
      area.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h3>Suivi Documents</h3>
          <div><button id="addDocBtn" class="btn primary">+ Ajouter Document</button></div>
        </div>
        <div style="overflow:auto">
          <table class="table" id="suiviTable">
            <thead><tr><th>Ref</th><th>Fournisseur</th><th>Date</th><th>Montant</th><th>Actions</th></tr></thead>
            <tbody id="suiviTbody"></tbody>
          </table>
        </div>
      `;
      renderSuiviTable();
      document.getElementById('addDocBtn').addEventListener('click', ()=> openSuiviModal());
    }

    function renderSuiviTable(){
      const tbody = $('suiviTbody');
      const list = suiviCache || [];
      if(!list.length){ tbody.innerHTML = `<tr><td colspan="5" class="small muted">Aucun document</td></tr>`; return; }
      tbody.innerHTML = list.map(s => `
        <tr>
          <td>${escapeHtml(s.RefDocument||'')}</td>
          <td>${escapeHtml(s.Fournisseur||'')}</td>
          <td>${escapeHtml(s.Date_STEXT||'')}</td>
          <td>${s.Montant!=null ? s.Montant : ''}</td>
          <td>
            <button class="btn" onclick="openSuiviDetails(${s.IDSuivi})">Voir</button>
            <button class="btn" onclick="openSuiviEdit(${s.IDSuivi})">Modifier</button>
            <button class="btn danger" onclick="deleteSuivi(${s.IDSuivi})">Supprimer</button>
          </td>
        </tr>
      `).join('');
    }

    function openSuiviModal(data=null){
      const isEdit = !!data;
      const s = data || { IDSuivi:null, RefDocument:'', Fournisseur:'', Date_STEXT:'', Date_R:'', Mode_R:'', Montant:'', Saisie:'', Compatibilite:'', Observation:''};
      const root = $('modalRoot'); root.style.display='block';
      root.innerHTML = `
        <div class="modal-backdrop"><div class="modal">
          <h3>${isEdit? 'Modifier Document' : 'Ajouter Document'}</h3>
          <div class="form-row"><div class="form-col"><label>Réf</label><input id="s_Ref" type="text" value="${escapeHtml(s.RefDocument||'')}" /></div><div class="form-col"><label>Fournisseur</label><input id="s_Four" type="text" value="${escapeHtml(s.Fournisseur||'')}" /></div></div>
          <div class="form-row"><div class="form-col"><label>Date (Saisie)</label><input id="s_DateS" type="date" value="${escapeHtml(s.Date_STEXT||'')}" /></div><div class="form-col"><label>Date R</label><input id="s_DateR" type="date" value="${escapeHtml(s.Date_R||'')}" /></div></div>
          <div class="form-row"><div class="form-col"><label>Mode R</label><input id="s_Mode" type="text" value="${escapeHtml(s.Mode_R||'')}" /></div><div class="form-col"><label>Montant</label><input id="s_Mont" type="text" value="${escapeHtml(s.Montant||'')}" /></div></div>
          <div class="form-row"><div class="form-col"><label>Justificatif (image)</label><input id="s_File1" type="file" accept="image/*" /></div><div class="form-col"><label>Document (image/pdf)</label><input id="s_File2" type="file" /></div></div>
          <div class="form-row"><div class="form-col"><label>Observation</label><textarea id="s_Obs">${escapeHtml(s.Observation||'')}</textarea></div></div>

          <div class="actions">
            ${isEdit? '<button id="delSuiviBtn" class="btn danger">Supprimer</button>':''}
            <button id="cancelSuivi" class="btn">Annuler</button>
            <button id="saveSuivi" class="btn primary">${isEdit? 'Sauvegarder' : 'Enregistrer'}</button>
          </div>
        </div></div>
      `;

      root.querySelector('#cancelSuivi').onclick = closeModal;
      root.querySelector('#saveSuivi').onclick = async () => {
        const payload = {
          IDSuivi: s.IDSuivi || undefined,
          RefDocument: document.getElementById('s_Ref').value.trim(),
          Fournisseur: document.getElementById('s_Four').value.trim(),
          Date_STEXT: document.getElementById('s_DateS').value,
          Date_R: document.getElementById('s_DateR').value,
          Mode_R: document.getElementById('s_Mode').value.trim(),
          Montant: parseFloat(document.getElementById('s_Mont').value) || 0,
          Observation: document.getElementById('s_Obs').value.trim()
        };

        const f1 = document.getElementById('s_File1');
        const f2 = document.getElementById('s_File2');
        try{
          if(f1 && f1.files[0]){
            const base = await fileToBase64(f1.files[0]);
            payload.ImageJustificatif_FileData = base.data;
            payload.ImageJustificatif_FileName = base.name;
            payload.ImageJustificatif_FileType = base.type;
          }
          if(f2 && f2.files[0]){
            const base2 = await fileToBase64(f2.files[0]);
            payload.ImageDoc_FileData = base2.data;
            payload.ImageDoc_FileName3 = base2.name;
            payload.ImageDoc_FileType = base2.type;
          }

          if(isEdit) await window.electronAPI.updateSuiviDoc(payload);
          else await window.electronAPI.addSuiviDoc(payload);
          alert('Document enregistré.');
          closeModal();
          suiviCache = await window.electronAPI.getSuiviDocs();
          renderSuiviTable();
        }catch(e){ console.error(e); alert('Erreur sauvegarde document'); }
      };

      if(isEdit){
        root.querySelector('#delSuiviBtn').onclick = async () => {
          if(!confirm('Supprimer document ?')) return;
          await window.electronAPI.deleteSuiviDoc(Number(s.IDSuivi));
          suiviCache = await window.electronAPI.getSuiviDocs();
          renderSuiviTable();
          closeModal();
        };
      }
    }

    async function openSuiviDetails(IDSuivi){
      const list = await window.electronAPI.getSuiviDocs();
      const s = list.find(x=>x.IDSuivi===IDSuivi);
      if(!s) return alert('Introuvable');
      const root = $('modalRoot'); root.style.display='block';
      root.innerHTML = `
        <div class="modal-backdrop"><div class="modal">
          <h3>Document ${escapeHtml(s.RefDocument||'')}</h3>
          <p><strong>Fournisseur:</strong> ${escapeHtml(s.Fournisseur||'')}</p>
          <p><strong>Date:</strong> ${escapeHtml(s.Date_STEXT||'')}</p>
          <p><strong>Montant:</strong> ${s.Montant || ''}</p>
          <p><strong>Observation:</strong> ${escapeHtml(s.Observation||'')}</p>
          <div style="margin-top:10px">
            <strong>Fichiers:</strong>
            <div class="file-preview">
              ${s.ImageJustificatif_FileName ? `<div class="file-item">${escapeHtml(s.ImageJustificatif_FileName)}</div>` : ''}
              ${s.ImageDoc_FileName3 ? `<div class="file-item">${escapeHtml(s.ImageDoc_FileName3)}</div>` : ''}
            </div>
          </div>
          <div class="actions">
            <button id="closeSuivi" class="btn">Fermer</button>
          </div>
        </div></div>
      `;
      root.querySelector('#closeSuivi').onclick = closeModal;
    }

    window.openSuiviEdit = async function(IDSuivi){
      const s = (await window.electronAPI.getSuiviDocs()).find(x=>x.IDSuivi===IDSuivi);
      openSuiviModal(s);
    }

    async function deleteSuivi(IDSuivi){
      if(!confirm('Supprimer document ?')) return;
      try{ await window.electronAPI.deleteSuiviDoc(Number(IDSuivi)); suiviCache = await window.electronAPI.getSuiviDocs(); renderSuiviTable(); alert('Supprimé'); }
      catch(e){ console.error(e); alert('Erreur suppression'); }
    }

    /* ===================== SETTINGS ===================== */
    function renderSettings(){
      $('pageTitle').textContent = 'Paramètres';
      $('pageSubtitle').textContent = 'Réglages de l\'application';
      const area = $('contentArea');
      area.innerHTML = `
        <h3>Paramètres</h3>
        <p class="small muted">Ici tu peux ajouter configurations spécifiques (ex: impr. par défaut, profil cabinet,...)</p>
        <div style="margin-top:10px">
          <button id="btnSync" class="btn">Synchroniser caches</button>
        </div>
      `;
      $('btnSync').addEventListener('click', async ()=>{
        await loadAllCaches();
        alert('Synchronisation terminée');
      });
    }

    /* ===================== UTIL ===================== */
    async function searchPatient(){
      const q = ( $('searchInput').value || '' ).trim().toLowerCase();
      if(!q) return alert('Saisis nom ou CIN');
      const list = await window.electronAPI.getPatients();
      const found = list.find(p => ((p.Nom||'').toLowerCase()===q) || ((p.Prenom||'') + ' ' + (p.Nom||'')).toLowerCase()===q || ((p.CIN||'').toLowerCase()===q));
      const resDiv = $('searchResult');
      if(!found){ resDiv.innerHTML = `<div class="small muted">Aucun patient</div>`; return; }
      resDiv.innerHTML = `
        <div class="patient-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${escapeHtml(found.Nom||'')} ${escapeHtml(found.Prenom||'')}</strong><div class="small muted">${escapeHtml(found.CIN||'')}</div></div>
            <div><button class="btn" onclick="openPatientDetailsModalById(${found.IDP})">Voir</button></div>
          </div>
          <div class="small" style="margin-top:8px">${escapeHtml(found.Tel||'')}</div>
        </div>
      `;
    }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>{
          const arr = reader.result.split(',');
          resolve({ data: arr[1], name: file.name, type: file.type });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // expose some for inline onclick usage
    window.openPatientDetailsModal = openPatientDetailsModal;
    window.openPatientEditModal = openPatientEditModal;
    window.openConsultEdit = openConsultEdit;
    window.openConsultDetails = openConsultDetails;
    window.copyConsultationRef = copyConsultationRef;
    window.openConsultationSelector = openConsultationSelector;
    window.selectConsultation = selectConsultation;

  </script>
</body>
</html>