<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Secr√©taire</title>
  <style>
    /* CSS Variables for consistent theming */
    :root {
      --primary-color: #0ea5a4;
      --primary-dark: #0d948b;
      --secondary-color: #1e293b;
      --accent-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --light-bg: #f8fafc;
      --dark-bg: #1e293b;
      --sidebar-width: 260px;
      --right-panel-width: 320px;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --transition: all 0.2s ease;
    }

    * { 
      box-sizing: border-box; 
      margin:0; 
      padding:0; 
      font-family: "Segoe UI", Roboto, -apple-system, BlinkMacSystemFont, sans-serif; 
    }
    
    body { 
      display:flex; 
      height:100vh; 
      background:var(--light-bg); 
      overflow:hidden;
      color: #1e293b;
    }

    /* Enhanced Sidebar */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--dark-bg); 
      color: white; 
      display:flex; 
      flex-direction:column; 
      padding:20px 0; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 10;
      transition: var(--transition);
    }
    
    .sidebar-header { 
      text-align:center; 
      margin-bottom:24px; 
      padding: 0 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .sidebar-header h2 { 
      font-size: 1.3rem;
      font-weight: 700;
      color: white;
    }
    
      .brand {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .brand-icon {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .role {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
      padding-left: 34px;
    }
    
    .menu {
      flex: 1;
      overflow: auto;
      padding: 0 12px;
    }
    
    .menu-item {
      padding: 12px 14px;
      border-radius: var(--radius);
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .menu-item:hover {
      background: var(--sidebar-hover);
      color: #fff;
    }
    
    .menu-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
      box-shadow: 0 2px 5px rgba(14, 165, 164, 0.3);
    }
    
    .menu-item .label {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .menu-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logout-btn { 
      background: rgba(239, 68, 68, 0.1); 
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fecaca; 
      padding:12px; 
      margin:15px; 
      border-radius:var(--border-radius); 
      cursor:pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
    }

    /* Main Content Area */
    .main-content { 
      flex:1 1 auto; 
      display:flex; 
      flex-direction:column; 
      padding:24px; 
      min-width:0;
      overflow: hidden;
    }
    
    .main-header { 
      display:flex; 
      align-items:center; 
      gap:12px; 
      justify-content:space-between; 
      margin-bottom:24px; 
      padding-bottom: 16px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .main-header h3 { 
      font-size:24px; 
      color:#0f172a;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .main-header .subtitle {
      font-size: 14px;
      color: #64748b;
    }

    .controls { 
      display:flex; 
      gap:8px; 
      align-items:center; 
    }
    
    .controls small { 
      margin-left:8px; 
      color:#64748b;
      font-weight: 500;
      background: #f1f5f9;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .content-area { 
      background:white; 
      flex:1; 
      border-radius:var(--border-radius); 
      padding:24px; 
      box-shadow: var(--box-shadow); 
      overflow:auto;
      border: 1px solid #e2e8f0;
    }

    /* Enhanced Timetable */
    .timetable { 
      width:max-content; 
      min-width:100%; 
      border-collapse:collapse;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }
    
    .timetable th, .timetable td { 
      border:1px solid #e2e8f0; 
      padding:12px 16px; 
      vertical-align:top; 
      min-width:140px; 
      height:80px; 
      font-size:13px; 
    }
    
    .timetable th { 
      background:#f8fafc; 
      text-align:center;
      font-weight: 600;
      color: #1e293b;
      text-transform: uppercase;
      font-size: 13px;
    }
    
    .time-col { 
      width:80px; 
      background:#f8fafc; 
      font-weight:600; 
      text-align:center;
      color: #1e293b;
    }
    
    .slot { 
      height:100%; 
      cursor:pointer; 
      position:relative;
      transition: var(--transition);
    }
    
    .slot:hover {
      background: rgba(14, 165, 164, 0.05);
    }
    
    .appt { 
      margin:2px; 
      padding:8px; 
      border-radius:6px; 
      font-size:12px; 
      cursor:pointer; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      white-space:nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: var(--transition);
      font-weight: 500;
    }
    
    .appt:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Enhanced Right Panel */
    .right-panel { 
      width: var(--right-panel-width); 
      flex-shrink:0; 
      background:var(--light-bg); 
      border-left:1px solid #e2e8f0; 
      padding:24px; 
      overflow-y:auto; 
      position:sticky; 
      top:0; 
      height:100vh;
    }
    
    .search-box input { 
      width:100%; 
      padding:10px 12px; 
      border-radius:var(--border-radius); 
      border:1px solid #cbd5e1; 
      margin-bottom: 16px;
      transition: var(--transition);
      font-size: 14px;
    }
    
    .search-box input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(14, 165, 164, 0.2);
      outline: none;
    }
    
    .patient-info { 
      background:white; 
      border-radius:var(--border-radius); 
      padding:16px; 
      box-shadow: var(--box-shadow); 
      margin-top:8px;
      border-left: 3px solid var(--primary-color);
    }

    /* Enhanced Modal */
    .modal-backdrop { 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.5); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      z-index:1000;
      backdrop-filter: blur(2px);
    }
    
    .modal { 
      background:white; 
      padding:24px; 
      border-radius:var(--border-radius); 
      width:450px; 
      max-width:95%; 
      max-height: 90vh;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      animation: modalAppear 0.3s ease-out;
      overflow-y: auto;
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal h3, .modal h4 {
      margin-bottom: 16px;
      color: #0f172a;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 12px;
      font-size: 18px;
      font-weight: 700;
    }
    
    .modal label { 
      display:block; 
      margin-top:16px; 
      font-size:14px; 
      color:#1e293b;
      font-weight: 500;
    }
    
    .modal input, .modal select, .modal textarea { 
      width:100%; 
      padding:10px 12px; 
      margin-top:6px; 
      border:1px solid #cbd5e1; 
      border-radius:var(--border-radius);
      transition: var(--transition);
      font-size: 14px;
    }
    
    .modal input:focus, .modal select:focus, .modal textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(14, 165, 164, 0.2);
      outline: none;
    }
    
    .modal .actions { 
      display:flex; 
      gap:8px; 
      justify-content:flex-end; 
      margin-top:24px; 
    }
    
    .btn { 
      padding:10px 16px; 
      border-radius:var(--border-radius); 
      cursor:pointer; 
      border:none;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 14px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    
    .btn.primary { 
      background:var(--primary-color); 
      color:#fff; 
    }
    
    .btn.primary:hover {
      background: var(--primary-dark);
    }
    
    .btn.secondary {
      background: #f1f5f9;
      color: #475569;
    }
    
    .btn.secondary:hover {
      background: #e2e8f0;
    }
    
    .btn.warn { 
      background:var(--warning-color); 
      color:#1e293b; 
    }
    
    .btn.danger { 
      background:var(--danger-color); 
      color:#fff; 
    }

    /* Enhanced Patient Table */
    #patientsTable {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    
    #patientsTable th {
      background: #f8fafc;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: #1e293b;
      border-bottom: 1px solid #e2e8f0;
      text-transform: uppercase;
      font-size: 13px;
    }
    
    #patientsTable td {
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    
    #patientsTable tr:hover {
      background-color: #f8fafc;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-planned {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-confirmed {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 900px) {
      .right-panel {
        display: none;
      }
      
      .sidebar {
        width: 70px;
      }
      
      .sidebar-header h2, .menu-item .label span:not(.icon) {
        display: none;
      }
      
      .sidebar-header {
        justify-content: center;
      }
    }
    
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        padding: 10px;
      }
      
      .sidebar-header {
        margin-bottom: 0;
        margin-right: 15px;
      }
      
      .menu {
        display: flex;
        flex: 1;
        overflow-x: auto;
      }
      
      .menu-item {
        white-space: nowrap;
        border-left: none;
        border-bottom: 3px solid transparent;
      }
      
      .menu-item.active {
        border-left: none;
        border-bottom-color: var(--primary-color);
      }
      
      .logout-btn {
        margin: 0;
      }
      
      .main-content {
        padding: 16px;
      }
      
      .content-area {
        padding: 16px;
      }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    /* Enhanced Table Styling */
#consultationsTable, #ordonnancesTable {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  border-radius: var(--border-radius);
  overflow: hidden;
  border: 1px solid #e2e8f0;
  background: white;
}

#consultationsTable th, #ordonnancesTable th {
  background: #f8fafc;
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: #1e293b;
  border-bottom: 1px solid #e2e8f0;
  text-transform: uppercase;
  font-size: 13px;
}

#consultationsTable td, #ordonnancesTable td {
  padding: 12px 16px;
  border-bottom: 1px solid #e2e8f0;
  font-size: 14px;
  vertical-align: top;
}

#consultationsTable tr:hover, #ordonnancesTable tr:hover {
  background-color: #f8fafc;
}

/* Form Grid Layout */
.modal .form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.modal .form-full {
  grid-column: 1 / -1;
}

/* Responsive Tables */
@media (max-width: 768px) {
  #consultationsTable, #ordonnancesTable {
    display: block;
    overflow-x: auto;
  }
  
  .modal .form-grid {
    grid-template-columns: 1fr;
  }
}
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Cabinet Dentaire</h2>
    </div>
    <div class="menu">
      <div class="menu-item active" data-page="emploi">
        <span class="label">
                    <span class="icon">

            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 5.5V7H9V5.5L3 7V9L5 9.5V15.5L3 16V18L9 16.5V18H15V16.5L21 18V16L19 15.5V9.5L21 9Z" fill="white"/>
            </svg>
            </span>
          <span>Emploi du Temps</span>
        </span>
      </div>

      <div class="menu-item" data-page="consultation">
        <span class="label">
          <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM7 7H9V9H7V7ZM7 11H9V13H7V11ZM7 15H9V17H7V15ZM17 17H11V15H17V17ZM17 13H11V11H17V13ZM17 9H11V7H17V9Z" fill="currentColor"/>
              </svg>
            </span>
          <span>Consultation</span>
        </span>
      </div>

      <div class="menu-item" data-page="patients">
        <span class="label">
          <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 4C16 2.89 16.89 2 18 2C19.11 2 20 2.89 20 4C20 5.11 19.11 6 18 6C16.89 6 16 5.11 16 4ZM20 22V16H16V22H20ZM22 22H10V16H8V22H6V16H4.5V9.5C4.5 8.12 5.62 7 7 7H11C12.38 7 13.5 8.12 13.5 9.5V16H22V22ZM8 7C8 5.62 9.12 4.5 10.5 4.5C11.88 4.5 13 5.62 13 7C13 8.38 11.88 9.5 10.5 9.5C9.12 9.5 8 8.38 8 7Z" fill="currentColor"/>
              </svg>
            </span>
          <span>Patients</span>
        </span>
      </div>

      <div class="menu-item" data-page="ordonnance">
        <span class="label">
          <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15H16V17H8V15ZM8 11H16V13H8V11Z" fill="currentColor"/>
              </svg>
            </span>
          <span>Ordonnances</span>
        </span>
      </div>

      <div class="menu-item" data-page="setting">
        <span class="label">
          <span class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15H16V17H8V15ZM8 11H16V13H8V11Z" fill="currentColor"/>
              </svg>
            </span>
          <span>Param√®tres</span>
        </span>
      </div>
    </div>
    <button id="logoutBtn" class="logout-btn">
      <span>Se d√©connecter</span>
    </button>
  </div>

  <div class="main-content">
    <div class="main-header">
      <div>
        <h3 id="title">Emploi du Temps</h3>
        <div class="subtitle" id="subtitle">Semaine en cours</div>
      </div>
      <div class="controls" id="weekControls" style="display:none;">
        <button id="prevWeek" class="btn secondary">‚óÄ</button>
        <button id="todayBtn" class="btn secondary">Aujourd'hui</button>
        <button id="nextWeek" class="btn secondary">‚ñ∂</button>
        <small id="weekRange"></small>
      </div>
    </div>

    <div class="content-area" id="content-area"></div>
  </div>

  <div class="right-panel">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Rechercher un patient par nom...">
    </div>
    <button id="searchBtn" class="btn primary" style="width: 100%; margin-bottom: 16px;">Rechercher</button>
    <div id="searchResult"></div>
  </div>

  <div id="modalRoot" style="display:none;"></div>

  <script>
    // Your existing JavaScript code remains exactly the same
    const toISODate = d => d.toISOString().split('T')[0];
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    function getMonday(d){ const date=new Date(d); const day=date.getDay(); const diff=date.getDate()-((day+6)%7); return new Date(date.setDate(diff)); }
    function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    let currentWeekStart = getMonday(new Date());
    let appointmentsCache = [];

    const pages = {
  emploi: renderWeek,
  consultation: () => {
    document.getElementById("title").textContent = "Consultation";
    document.getElementById("subtitle").textContent = "Gestion des consultations";
    document.getElementById('weekControls').style.display = 'none';
    renderConsultationPage();
  },
  ordonnance: () => {
    document.getElementById("title").textContent = "Ordonnances";
    document.getElementById("subtitle").textContent = "Liste des ordonnances";
    document.getElementById('weekControls').style.display = 'none';
    renderOrdonnancePage();
  },
  patients: () => {
    document.getElementById("title").textContent = "Les Patients";
    document.getElementById("subtitle").textContent = "Gestion des patients";
    document.getElementById('weekControls').style.display = 'none';
    renderPatientsPage();
  },
  setting: () => {
    document.getElementById("title").textContent = "Param√®tres";
    document.getElementById("subtitle").textContent = "R√©glages de l'application";
    document.getElementById("content-area").innerHTML = `<h2>Param√®tres</h2><p>R√©glages de l'application...</p>`;
    document.getElementById('weekControls').style.display = 'none';
  }
};

    window.addEventListener('DOMContentLoaded', async () => {
      // Authentication check
      const user = await window.electronAPI.getCurrentUser();
      if(!user || user.Droit.toLowerCase()!=='secretary'){ alert('‚õî Acc√®s refus√©.'); window.location.replace('login.html'); return; }

      document.getElementById('logoutBtn').addEventListener('click', () => window.electronAPI.logout());
      
      // Week control buttons
      document.getElementById('prevWeek').addEventListener('click', () => { currentWeekStart=addDays(currentWeekStart,-7); renderWeek(); });
      document.getElementById('nextWeek').addEventListener('click', () => { currentWeekStart=addDays(currentWeekStart,7); renderWeek(); });
      document.getElementById('todayBtn').addEventListener('click', () => { currentWeekStart=getMonday(new Date()); renderWeek(); });

      // Search
      document.getElementById('searchBtn').addEventListener('click', searchPatient);
      document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key==='Enter') searchPatient(); });

      // Menu navigation
      document.querySelectorAll(".menu-item").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".menu-item").forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
          const page = btn.dataset.page;
          if(pages[page]) pages[page]();
        });
      });

      pages['emploi'](); // default page
    });

    // Render Patients Page 
    async function renderPatientsPage() {
      const area = document.getElementById("content-area");
      area.innerHTML = `<h2>Patients</h2>
        <button class="btn primary" id="addPatientBtn">+ Ajouter un patient</button>
        <br><br>
        <table id="patientsTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Pr√©nom</th>
              <th>CIN</th>
              <th>T√©l√©phone</th>
              <th>Ville</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="patientsTbody"></tbody>
        </table>
      `;

      const patients = await window.electronAPI.getPatients() || [];
      const tbody = document.getElementById("patientsTbody");

      tbody.innerHTML = patients.map(p => `
        <tr>
          <td>${escapeHtml(p.Nom)}</td>
          <td>${escapeHtml(p.Prenom)}</td>
          <td>${escapeHtml(p.CIN || '')}</td>
          <td>${escapeHtml(p.Tel || '')}</td>
          <td>${escapeHtml(p.Ville || '')}</td>
          <td>
            <button class="btn secondary" onclick="openPatientEdit(${p.IDP})">Modifier</button>
            <button class="btn primary" onclick="openPatientDetails(${p.IDP})">D√©tails</button>
          </td>
        </tr>
      `).join("");

      document.getElementById("addPatientBtn").addEventListener("click", () => openPatientModal());
    }

    function openPatientModal(data = null) {
      const isEdit = !!data;

      const patientData = data || {
        Nom: "", Prenom: "", CIN: "",
        DateNaissance: "",
        Tel: "", Email: "",
        Adresse: "", Ville: "",
        Allergies: "", Remarques: ""
      };

      const formHtml = `
        <label>Nom :</label>
        <input type="text" id="Nom" value="${patientData.Nom}">

        <label>Pr√©nom :</label>
        <input type="text" id="Prenom" value="${patientData.Prenom}">

        <label>CIN :</label>
        <input type="text" id="CIN" value="${patientData.CIN}">

        <label>Date de Naissance :</label>
        <input type="date" id="DateNaissance" value="${patientData.DateNaissance}">

        <label>T√©l√©phone :</label>
        <input type="text" id="Tel" value="${patientData.Tel}">

        <label>Email :</label>
        <input type="email" id="Email" value="${patientData.Email}">

        <label>Adresse :</label>
        <input type="text" id="Adresse" value="${patientData.Adresse}">

        <label>Ville :</label>
        <input type="text" id="Ville" value="${patientData.Ville}">

        <label>Allergies :</label>
        <textarea id="Allergies">${patientData.Allergies}</textarea>

        <label>Remarques :</label>
        <textarea id="Remarques">${patientData.Remarques}</textarea>
      `;

      openPatientFormModal({
        title: isEdit ? "Modifier Patient" : "Ajouter Patient",
        content: formHtml,

        onSave: async () => {
          const form = {
            Nom: document.getElementById("Nom").value,
            Prenom: document.getElementById("Prenom").value,
            CIN: document.getElementById("CIN").value,
            DateNaissance: document.getElementById("DateNaissance").value,
            Tel: document.getElementById("Tel").value,
            Email: document.getElementById("Email").value,
            Adresse: document.getElementById("Adresse").value,
            Ville: document.getElementById("Ville").value,
            Allergies: document.getElementById("Allergies").value,
            Remarques: document.getElementById("Remarques").value
          };

          try {
            if (isEdit) {
              form.IDP = data.IDP;
              await window.electronAPI.updatePatient(form);
              alert("Patient modifi√©.");
            } else {
              await window.electronAPI.addPatient(form);
              alert("Patient ajout√©.");
            }

            closeModal();
            renderPatientsPage();

          } catch(e) {
            console.error(e);
            alert("Erreur lors de l'enregistrement.");
          }
        }
      });
    }

    function openPatientFormModal({ title, content, onSave }) {
      const root = document.getElementById("modalRoot");
      root.style.display = "block";

      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" role="dialog" aria-modal="true" style="max-height:90vh; overflow:auto;">
            <h3>${escapeHtml(title)}</h3>
            <div id="patientFormContent">
              ${content}
            </div>

            <div class="actions">
              <button class="btn secondary" id="cancelPatientBtn">Annuler</button>
              <button class="btn primary" id="savePatientBtn">Enregistrer</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("cancelPatientBtn").onclick = closeModal;
      document.getElementById("savePatientBtn").onclick = async () => {
        await onSave();
      };
    }

    async function openPatientEdit(id) {
      const list = await window.electronAPI.getPatients();
      const p = list.find(x => x.IDP === id);
      openPatientModal(p);
    }

    async function renderWeek(){
      document.getElementById('weekControls').style.display='flex';
      document.getElementById("subtitle").textContent = "Semaine en cours";

      const start = toISODate(currentWeekStart);
      const end = toISODate(addDays(currentWeekStart,6));
      document.getElementById('weekRange').textContent = `${start} ‚Üí ${end}`;

      appointmentsCache = await window.electronAPI.getAppointments({startDate:start,endDate:end})||[];

      const hours=["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];
      const days=Array.from({length:7},(_,i)=>addDays(currentWeekStart,i));

      let html=`<table class="timetable"><thead><tr><th class="time-col">Heures</th>`;
      days.forEach(d=>html+=`<th>${d.toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'2-digit'})}</th>`);
      html+=`</tr></thead><tbody>`;

      hours.forEach(hour=>{
        html+=`<tr><td class="time-col">${hour}</td>`;
        days.forEach(day=>{
          const dateStr=toISODate(day);
          const cellId=`${dateStr}__${hour}`;
          const appts=appointmentsCache.filter(a=>a.DateRv===dateStr && a.HeureRv===hour);
          let cellHtml=`<div class="slot" data-date="${dateStr}" data-time="${hour}" id="${cellId}">`;
          appts.forEach(a=>{
            let color='#dbeafe';
            if(a.Statut==='Confirm√©') color='#d1fae5';
            else if(a.Statut==='Annul√©') color='#fee2e2';
            cellHtml+=`<div class="appt" data-id="${a.IDRv}" style="background:${color}">${escapeHtml(a.NomPrenom||a.TypePatient||'RDV')}</div>`;
          });
          cellHtml+='</div>';
          html+=`<td>${cellHtml}</td>`;
        });
        html+='</tr>';
      });
      html+='</tbody></table>';
      document.getElementById('content-area').innerHTML=html;

      document.querySelectorAll('.slot').forEach(slot=>{
        slot.addEventListener('click', e=>{
          const apptDiv=e.target.closest('.appt');
          if(apptDiv) openEditModal(apptDiv.dataset.id);
          else openCreateModal(slot.dataset.date, slot.dataset.time);
        });
      });
    }

    function openCreateModal(date,time) {
      openModal({
        title:`Cr√©er RDV ‚Äî ${date} ${time}`,
        data:{IDRv:null,DateRv:date,HeureRv:time,IDP:null,NomPrenom:'',Email:'',Statut:'Planifi√©',TypePatient:'',CIN:''},

        onSave: async data => {
          try {
            // 1) Get all patients
            const patients = await window.electronAPI.getPatients();

            // 2) Find patient by CIN
            const p = patients.find(x => (x.CIN||"").trim().toLowerCase() === data.CIN.toLowerCase());

            if (!p) {
              alert("‚ùå Aucun patient avec ce CIN.");
              return;
            }

            // 3) Use the real patient ID
            data.IDP = p.IDP;

            // 4) Save
            await window.electronAPI.createAppointment(data);

            renderWeek();
            closeModal();
            alert("RDV cr√©√©.");

          } catch(err) {
            console.error(err);
            alert("Erreur cr√©ation RDV.");
          }
        }
      });
    }

    async function openEditModal(IDRv){
      const appt=await window.electronAPI.getAppointment(Number(IDRv));
      if(!appt){alert('RDV introuvable');return;}
      openModal({
        title:`Modifier RDV ‚Äî ${appt.DateRv} ${appt.HeureRv}`,
        data:{...appt},
        onSave:async data=>{try{await window.electronAPI.updateAppointment(data); renderWeek(); closeModal(); alert('RDV modifi√©.');}catch(err){console.error(err);alert('Erreur modification.');}},
        onDelete:async ()=>{if(!confirm('Supprimer ce RDV ?'))return;try{await window.electronAPI.deleteAppointment(Number(IDRv)); renderWeek(); closeModal();alert('RDV supprim√©.');}catch(err){console.error(err);alert('Erreur suppression.');}}
      });
    }

    function openModal({title,data,onSave,onDelete}) {
      const root = document.getElementById('modalRoot'); 
      root.style.display='block';

      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" role="dialog" aria-modal="true">
            <h4>${escapeHtml(title)}</h4>

            <label>CIN du patient</label>
            <input id="m_CIN" value="${escapeHtml(data.CIN||'')}" />

            <label>Nom / NomPrenom</label>
            <input id="m_NomPrenom" value="${escapeHtml(data.NomPrenom||'')}" />

            <label>Email</label>
            <input id="m_Email" value="${escapeHtml(data.Email||'')}" />

            <label>Type</label>
            <input id="m_TypePatient" value="${escapeHtml(data.TypePatient||'')}" />

            <label>Statut</label>
            <select id="m_Statut">
              <option ${data.Statut==='Planifi√©'?'selected':''}>Planifi√©</option>
              <option ${data.Statut==='Confirm√©'?'selected':''}>Confirm√©</option>
              <option ${data.Statut==='Annul√©'?'selected':''}>Annul√©</option>
            </select>

            <label>Date</label>
            <input id="m_DateRv" type="date" value="${escapeHtml(data.DateRv||'')}" />

            <label>Heure</label>
            <input id="m_HeureRv" type="time" value="${escapeHtml(data.HeureRv||'')}" />

            <div class="actions">
              ${onDelete ? '<button id="deleteBtn" class="btn danger">Supprimer</button>' : ''}
              <button id="cancelBtn" class="btn secondary">Annuler</button>
              <button id="saveBtn" class="btn primary">Sauvegarder</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('cancelBtn').onclick = closeModal;

      document.getElementById('saveBtn').onclick = async () => {
        const payload = {
          CIN: document.getElementById('m_CIN').value.trim(),
          IDRv: data.IDRv || null,
          IDP: data.IDP || null,
          NomPrenom: document.getElementById('m_NomPrenom').value.trim(),
          Email: document.getElementById('m_Email').value.trim(),
          TypePatient: document.getElementById('m_TypePatient').value.trim(),
          Statut: document.getElementById('m_Statut').value,
          DateRv: document.getElementById('m_DateRv').value,
          HeureRv: document.getElementById('m_HeureRv').value
        };

        await onSave(payload);
      };

      if(onDelete) document.getElementById('deleteBtn').onclick = onDelete;
    }

    function closeModal(){ const root=document.getElementById('modalRoot'); root.style.display='none'; root.innerHTML=''; }

    async function openPatientDetails(id) {
      const patients = await window.electronAPI.getPatients();
      const p = patients.find(x => x.IDP === id);
      if (!p) return alert("Patient introuvable");

      const content = `
        <div id="patientDetailsContent">
          <p><strong>Nom:</strong> ${escapeHtml(p.Nom)}</p>
          <p><strong>Pr√©nom:</strong> ${escapeHtml(p.Prenom)}</p>
          <p><strong>CIN:</strong> ${escapeHtml(p.CIN)}</p>
          <p><strong>Date de Naissance:</strong> ${escapeHtml(p.DateNaissance)}</p>
          <p><strong>T√©l√©phone:</strong> ${escapeHtml(p.Tel)}</p>
          <p><strong>Email:</strong> ${escapeHtml(p.Email)}</p>
          <p><strong>Adresse:</strong> ${escapeHtml(p.Adresse)}</p>
          <p><strong>Ville:</strong> ${escapeHtml(p.Ville)}</p>
          <p><strong>Allergies:</strong> ${escapeHtml(p.Allergies)}</p>
          <p><strong>Remarques:</strong> ${escapeHtml(p.Remarques)}</p>
        </div>
        <button class="btn primary" id="exportPdfBtn">Exporter PDF</button>
      `;

      openPatientFormModal({
        title: "D√©tails Patient",
        content,
        onSave: null // read-only
      });

      // hide Save button, rename Cancel to Fermer
      document.getElementById("savePatientBtn")?.remove();
      document.getElementById("cancelPatientBtn").textContent = "Fermer";

      // PDF export
      document.getElementById("exportPdfBtn").onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        let y = 10;
        const lineHeight = 8;

        const addLine = (label, value) => {
          doc.text(`${label}: ${value || ''}`, 10, y);
          y += lineHeight;
        };

        addLine("Nom", p.Nom);
        addLine("Pr√©nom", p.Prenom);
        addLine("CIN", p.CIN);
        addLine("Date de Naissance", p.DateNaissance);
        addLine("T√©l√©phone", p.Tel);
        addLine("Email", p.Email);
        addLine("Adresse", p.Adresse);
        addLine("Ville", p.Ville);
        addLine("Allergies", p.Allergies);
        addLine("Remarques", p.Remarques);

        doc.save(`${p.CIN}.pdf`);
      };
    }

    async function searchPatient() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!q) return;

      const patients = await window.electronAPI.getPatients() || [];

      // Search by CIN OR Nom OR "Prenom Nom"
      const found = patients.find(p => 
        ((p.CIN || '').toLowerCase() === q) || 
        ((p.Nom || '').toLowerCase() === q) || 
        (((p.Prenom || '') + ' ' + (p.Nom || '')).toLowerCase() === q)
      );

      const resDiv = document.getElementById('searchResult');

      if (found) {
        resDiv.innerHTML = `
          <div class="patient-info">
            <p><strong>${escapeHtml(found.Nom)} ${escapeHtml(found.Prenom || '')}</strong></p>
            <p>CIN: ${escapeHtml(found.CIN || '')}</p>
            <p>T√©l√©: ${escapeHtml(found.Tel || '')}</p>
            <p>Email: ${escapeHtml(found.Email || '')}</p>
          </div>
        `;
      } else {
        resDiv.innerHTML = '';
        alert('‚ùå Patient non trouv√©.');
      }
    }
    // ======================================
// üìã CONSULTATION PAGE
// ======================================
async function renderConsultationPage() {
  const area = document.getElementById("content-area");
  area.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>Consultations</h2>
      <button class="btn primary" id="addConsultationBtn">+ Nouvelle Consultation</button>
    </div>
    
    <div style="margin-bottom: 20px;">
      <input type="text" id="searchConsultationInput" placeholder="Rechercher par CIN, nom du m√©decin..." style="padding: 8px 12px; width: 300px; border: 1px solid #cbd5e1; border-radius: var(--border-radius);">
      <button class="btn secondary" id="searchConsultationBtn">Rechercher</button>
      <button class="btn secondary" id="resetConsultationSearch">R√©initialiser</button>
    </div>

    <table id="consultationsTable" style="width: 100%; border: 1px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Patient</th>
          <th>CIN</th>
          <th>M√©decin</th>
          <th>Motif</th>
          <th>Date</th>
          <th>Pi√®ces Jointes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="consultationsTbody"></tbody>
    </table>
  `;

  await loadConsultations();

  document.getElementById("addConsultationBtn").addEventListener("click", () => openConsultationModal());
  document.getElementById("searchConsultationBtn").addEventListener("click", searchConsultations);
  document.getElementById("resetConsultationSearch").addEventListener("click", loadConsultations);
  document.getElementById("searchConsultationInput").addEventListener("keydown", e => {
    if (e.key === 'Enter') searchConsultations();
  });
}

async function loadConsultations(searchTerm = '') {
  try {
    const consultations = await window.electronAPI.getConsultations() || [];
    const tbody = document.getElementById("consultationsTbody");
    
    let filteredConsultations = consultations;
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filteredConsultations = consultations.filter(c => 
        (c.CIN && c.CIN.toLowerCase().includes(term)) ||
        (c.NomMedecin && c.NomMedecin.toLowerCase().includes(term)) ||
        (c.Motif && c.Motif.toLowerCase().includes(term))
      );
    }

    if (filteredConsultations.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px; color: #64748b;">Aucune consultation trouv√©e</td></tr>`;
      return;
    }

    // Get all patients for name lookup
    const patients = await window.electronAPI.getPatients() || [];
    
    tbody.innerHTML = filteredConsultations.map(c => {
      const patient = patients.find(p => p.IDP === c.IDP);
      const patientName = patient ? `${patient.Nom} ${patient.Prenom}` : 'N/A';
      const hasAttachment = c.Pi√®cesJointes_FileName ? 'üìé' : '';
      
      return `
        <tr>
          <td>${c.IDC}</td>
          <td>${escapeHtml(patientName)}</td>
          <td>${escapeHtml(c.CIN || '')}</td>
          <td>${escapeHtml(c.NomMedecin || '')}</td>
          <td>${escapeHtml(c.Motif || '').substring(0, 50)}${c.Motif && c.Motif.length > 50 ? '...' : ''}</td>
          <td>${escapeHtml(c.DateCreation || '')}</td>
          <td style="text-align: center;">${hasAttachment}</td>
          <td>
            <button class="btn secondary" onclick="openConsultationDetails(${c.IDC})">Voir</button>
            <button class="btn primary" onclick="openConsultationEdit(${c.IDC})">Modifier</button>
            <button class="btn danger" onclick="deleteConsultation(${c.IDC})">Supprimer</button>
          </td>
        </tr>
      `;
    }).join("");
  } catch (error) {
    console.error('Error loading consultations:', error);
    document.getElementById("consultationsTbody").innerHTML = 
      `<tr><td colspan="8" style="text-align: center; color: var(--danger-color);">Erreur lors du chargement</td></tr>`;
  }
}

function searchConsultations() {
  const searchTerm = document.getElementById("searchConsultationInput").value.trim();
  loadConsultations(searchTerm);
}

function openConsultationModal(data = null) {
  const isEdit = !!data;

  const consultationData = data || {
    IDC: null,
    IDP: null,
    CIN: '',
    Motif: '',
    Diagnostic: '',
    Observations: '',
    Remarques: '',
    NomMedecin: '',
    Pi√®cesJointes_FileName: '',
    consultation_ref: ''
  };

  const formHtml = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
      <div>
        <label>CIN du Patient *</label>
        <input type="text" id="consultation_CIN" value="${consultationData.CIN || ''}" 
               placeholder="Saisir le CIN du patient" ${isEdit ? 'readonly' : ''}>
        
        <label>Motif de Consultation *</label>
        <textarea id="consultation_Motif" rows="3" placeholder="D√©crire le motif de la consultation">${consultationData.Motif || ''}</textarea>
        
        <label>Diagnostic</label>
        <textarea id="consultation_Diagnostic" rows="3" placeholder="Diagnostic √©tabli">${consultationData.Diagnostic || ''}</textarea>
        
        <label>Nom du M√©decin *</label>
        <input type="text" id="consultation_NomMedecin" value="${consultationData.NomMedecin || ''}" 
               placeholder="Nom du m√©decin traitant">
      </div>
      
      <div>
        <label>Observations</label>
        <textarea id="consultation_Observations" rows="3" placeholder="Observations cliniques">${consultationData.Observations || ''}</textarea>
        
        <label>Remarques</label>
        <textarea id="consultation_Remarques" rows="3" placeholder="Remarques suppl√©mentaires">${consultationData.Remarques || ''}</textarea>
        
        <label>R√©f√©rence Consultation</label>
        <input type="text" id="consultation_ref" value="${consultationData.consultation_ref || generateConsultationRef()}" 
               placeholder="R√©f√©rence automatique">
        
        ${!isEdit ? `
        <label>Pi√®ce Jointe</label>
        <input type="file" id="consultation_File" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
        <small style="color: #64748b;">Formats accept√©s: PDF, JPG, PNG, DOC (max 5MB)</small>
        ` : `
        <label>Pi√®ce Jointe Actuelle</label>
        <div style="padding: 8px; background: #f8fafc; border-radius: 4px;">
          ${consultationData.Pi√®cesJointes_FileName ? 
            `<span>üìé ${consultationData.Pi√®cesJointes_FileName}</span>` : 
            'Aucun fichier'}
        </div>
        `}
      </div>
    </div>
  `;

  openConsultationFormModal({
    title: isEdit ? "Modifier Consultation" : "Nouvelle Consultation",
    content: formHtml,
    onSave: async () => {
      const form = {
        IDC: consultationData.IDC,
        CIN: document.getElementById("consultation_CIN").value.trim(),
        Motif: document.getElementById("consultation_Motif").value.trim(),
        Diagnostic: document.getElementById("consultation_Diagnostic").value.trim(),
        Observations: document.getElementById("consultation_Observations").value.trim(),
        Remarques: document.getElementById("consultation_Remarques").value.trim(),
        NomMedecin: document.getElementById("consultation_NomMedecin").value.trim(),
        consultation_ref: document.getElementById("consultation_ref").value.trim()
      };

      if (!form.CIN || !form.Motif || !form.NomMedecin) {
        alert("Veuillez remplir les champs obligatoires (CIN, Motif, M√©decin)");
        return;
      }

      try {
        // Get patient by CIN to get IDP
        const patient = await window.electronAPI.getPatientByCIN(form.CIN);
        if (!patient && !isEdit) {
          alert("‚ùå Aucun patient trouv√© avec ce CIN. Veuillez d'abord cr√©er le patient.");
          return;
        }
        form.IDP = patient ? patient.IDP : consultationData.IDP;

        // Handle file upload for new consultations
        if (!isEdit) {
          const fileInput = document.getElementById("consultation_File");
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
              alert("Le fichier est trop volumineux (max 5MB)");
              return;
            }
            
            // Convert file to base64 for storage
            const reader = new FileReader();
            reader.onload = async function(e) {
              form.Pi√®cesJointes_FileData = e.target.result.split(',')[1];
              form.Pi√®cesJointes_FileName = file.name;
              form.Pi√®cesJointes_FileType = file.type;
              
              await saveConsultation(form, isEdit);
            };
            reader.readAsDataURL(file);
            return;
          }
        }

        await saveConsultation(form, isEdit);

      } catch (e) {
        console.error(e);
        alert("Erreur lors de l'enregistrement: " + e.message);
      }
    }
  });
}

async function saveConsultation(form, isEdit) {
  try {
    if (isEdit) {
      await window.electronAPI.updateConsultation(form);
      alert("Consultation modifi√©e avec succ√®s");
    } else {
      await window.electronAPI.addConsultation(form);
      alert("Consultation cr√©√©e avec succ√®s");
    }

    closeModal();
    renderConsultationPage();
  } catch (e) {
    console.error(e);
    alert("Erreur lors de l'enregistrement de la consultation");
  }
}

async function openConsultationEdit(id) {
  try {
    const consultation = await window.electronAPI.getConsultationById(id);
    if (consultation) {
      openConsultationModal(consultation);
    } else {
      alert("Consultation non trouv√©e");
    }
  } catch (error) {
    console.error('Error loading consultation:', error);
    alert("Erreur lors du chargement de la consultation");
  }
}

async function openConsultationDetails(id) {
  try {
    const consultation = await window.electronAPI.getConsultationById(id);
    if (!consultation) {
      alert("Consultation non trouv√©e");
      return;
    }

    const patient = consultation.IDP ? await window.electronAPI.getPatientById(consultation.IDP) : null;
    const patientName = patient ? `${patient.Nom} ${patient.Prenom}` : 'N/A';

    const content = `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h4 style="margin-bottom: 16px; color: var(--primary-color);">Informations Patient</h4>
          <p><strong>Nom:</strong> ${escapeHtml(patientName)}</p>
          <p><strong>CIN:</strong> ${escapeHtml(consultation.CIN || '')}</p>
          <p><strong>M√©decin:</strong> ${escapeHtml(consultation.NomMedecin || '')}</p>
          <p><strong>Date:</strong> ${escapeHtml(consultation.DateCreation || '')}</p>
        </div>
        
        <div>
          <h4 style="margin-bottom: 16px; color: var(--primary-color);">D√©tails Consultation</h4>
          <p><strong>Motif:</strong> ${escapeHtml(consultation.Motif || '')}</p>
          <p><strong>Diagnostic:</strong> ${escapeHtml(consultation.Diagnostic || '')}</p>
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 16px; color: var(--primary-color);">Observations</h4>
        <div style="background: #f8fafc; padding: 16px; border-radius: 4px;">
          ${escapeHtml(consultation.Observations || 'Aucune observation')}
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 16px; color: var(--primary-color);">Remarques</h4>
        <div style="background: #f8fafc; padding: 16px; border-radius: 4px;">
          ${escapeHtml(consultation.Remarques || 'Aucune remarque')}
        </div>
      </div>
      
      ${consultation.Pi√®cesJointes_FileName ? `
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 16px; color: var(--primary-color);">Pi√®ce Jointe</h4>
        <button class="btn primary" onclick="downloadConsultationFile('${consultation.Pi√®cesJointes_FileName}')">
          üìé T√©l√©charger ${consultation.Pi√®cesJointes_FileName}
        </button>
      </div>
      ` : ''}
    `;

    openConsultationFormModal({
      title: "D√©tails Consultation",
      content,
      onSave: null
    });

    // Hide save button for details view
    document.getElementById("saveConsultationBtn")?.remove();
    document.getElementById("cancelConsultationBtn").textContent = "Fermer";

  } catch (error) {
    console.error('Error loading consultation details:', error);
    alert("Erreur lors du chargement des d√©tails");
  }
}

async function downloadConsultationFile(fileName) {
  try {
    const fileInfo = await window.electronAPI.getConsultationFile(fileName);
    if (fileInfo.exists) {
      // Create a temporary link to download the file
      const link = document.createElement('a');
      link.href = fileInfo.url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert("Fichier non trouv√©");
    }
  } catch (error) {
    console.error('Error downloading file:', error);
    alert("Erreur lors du t√©l√©chargement du fichier");
  }
}

async function deleteConsultation(id) {
  if (!confirm("√ätes-vous s√ªr de vouloir supprimer cette consultation ?")) {
    return;
  }

  try {
    await window.electronAPI.deleteConsultation(id);
    alert("Consultation supprim√©e avec succ√®s");
    renderConsultationPage();
  } catch (error) {
    console.error('Error deleting consultation:', error);
    alert("Erreur lors de la suppression de la consultation");
  }
}

function openConsultationFormModal({ title, content, onSave }) {
  const root = document.getElementById("modalRoot");
  root.style.display = "block";

  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" style="max-width: 800px; max-height: 90vh; overflow: auto;">
        <h3>${escapeHtml(title)}</h3>
        <div id="consultationFormContent">
          ${content}
        </div>

        <div class="actions">
          <button class="btn secondary" id="cancelConsultationBtn">Annuler</button>
          ${onSave ? `<button class="btn primary" id="saveConsultationBtn">Enregistrer</button>` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById("cancelConsultationBtn").onclick = closeModal;
  if (onSave) {
    document.getElementById("saveConsultationBtn").onclick = async () => {
      await onSave();
    };
  }
}

function generateConsultationRef() {
  return 'CONS-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
}

// ======================================
// üíä ORDONNANCE PAGE
// ======================================
async function renderOrdonnancePage() {
  const area = document.getElementById("content-area");
  area.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>Ordonnances</h2>
      <button class="btn primary" id="addOrdonnanceBtn">+ Nouvelle Ordonnance</button>
    </div>
    
    <div style="margin-bottom: 20px;">
      <input type="text" id="searchOrdonnanceInput" placeholder="Rechercher par CIN patient..." style="padding: 8px 12px; width: 300px; border: 1px solid #cbd5e1; border-radius: var(--border-radius);">
      <button class="btn secondary" id="searchOrdonnanceBtn">Rechercher</button>
      <button class="btn secondary" id="resetOrdonnanceSearch">R√©initialiser</button>
    </div>

    <table id="ordonnancesTable" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Patient</th>
          <th>CIN</th>
          <th>M√©decin</th>
          <th>M√©dicaments</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordonnancesTbody"></tbody>
    </table>
  `;

  await loadOrdonnances();

  document.getElementById("addOrdonnanceBtn").addEventListener("click", () => openOrdonnanceModal());
  document.getElementById("searchOrdonnanceBtn").addEventListener("click", searchOrdonnances);
  document.getElementById("resetOrdonnanceSearch").addEventListener("click", loadOrdonnances);
  document.getElementById("searchOrdonnanceInput").addEventListener("keydown", e => {
    if (e.key === 'Enter') searchOrdonnances();
  });
}

async function loadOrdonnances(searchTerm = '') {
  try {
    const ordonnances = await window.electronAPI.getOrdonnances() || [];
    const tbody = document.getElementById("ordonnancesTbody");
    
    let filteredOrdonnances = ordonnances;
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filteredOrdonnances = ordonnances.filter(o => 
        o.consultation_ref && o.consultation_ref.toLowerCase().includes(term)
      );
    }

    if (filteredOrdonnances.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: #64748b;">Aucune ordonnance trouv√©e</td></tr>`;
      return;
    }

    // Get all patients and consultations for data lookup
    const patients = await window.electronAPI.getPatients() || [];
    const consultations = await window.electronAPI.getConsultations() || [];
    
    tbody.innerHTML = filteredOrdonnances.map(o => {
      const consultation = consultations.find(c => c.IDC === o.IDC);
      const patient = patients.find(p => p.IDP === o.IDP);
      const patientName = patient ? `${patient.Nom} ${patient.Prenom}` : 'N/A';
      const patientCIN = patient ? patient.CIN : 'N/A';
      
      const medicaments = [
        o.Medicament1,
        o.Medicament2, 
        o.Medicament3
      ].filter(m => m && m.trim() !== '');
      
      const medicamentsText = medicaments.length > 0 
        ? medicaments.join(', ') 
        : 'Aucun m√©dicament';

      return `
        <tr>
          <td>${o.IDR}</td>
          <td>${escapeHtml(patientName)}</td>
          <td>${escapeHtml(patientCIN)}</td>
          <td>${escapeHtml(o.NomMedecin || '')}</td>
          <td>${escapeHtml(medicamentsText.substring(0, 50))}${medicamentsText.length > 50 ? '...' : ''}</td>
          <td>${escapeHtml(o.DateCreation || '')}</td>
          <td>
            <button class="btn secondary" onclick="openOrdonnanceDetails(${o.IDR})">Voir</button>
            <button class="btn primary" onclick="openOrdonnanceEdit(${o.IDR})">Modifier</button>
            <button class="btn danger" onclick="deleteOrdonnance(${o.IDR})">Supprimer</button>
          </td>
        </tr>
      `;
    }).join("");
  } catch (error) {
    console.error('Error loading ordonnances:', error);
    document.getElementById("ordonnancesTbody").innerHTML = 
      `<tr><td colspan="7" style="text-align: center; color: var(--danger-color);">Erreur lors du chargement</td></tr>`;
  }
}

function searchOrdonnances() {
  const searchTerm = document.getElementById("searchOrdonnanceInput").value.trim();
  loadOrdonnances(searchTerm);
}

function openOrdonnanceModal(data = null) {
  const isEdit = !!data;

  const ordonnanceData = data || {
    IDR: null,
    IDC: null,
    IDP: null,
    patientCIN: '',
    medecinName: '',
    M1: '', P1: '', D1: '',
    M2: '', P2: '', D2: '',
    M3: '', P3: '', D3: '',
    Remarques: '',
    consultation_ref: ''
  };

  const formHtml = `
    <div style="margin-bottom: 20px;">
      <label>CIN du Patient *</label>
      <input type="text" id="ordonnance_CIN" value="${ordonnanceData.patientCIN || ordonnanceData.CIN || ''}" 
             placeholder="Saisir le CIN du patient" ${isEdit ? 'readonly' : ''}>
      
      <label>Nom du M√©decin *</label>
      <input type="text" id="ordonnance_Medecin" value="${ordonnanceData.medecinName || ordonnanceData.NomMedecin || ''}" 
             placeholder="Nom du m√©decin prescripteur">
    </div>

    <h4 style="margin: 20px 0 10px 0; color: var(--primary-color);">M√©dicaments Prescrits</h4>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; font-weight: bold;">
      <div>M√©dicament</div>
      <div>Posologie</div>
      <div>Dur√©e</div>
    </div>
    
    <!-- M√©dicament 1 -->
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
      <input type="text" id="ordonnance_M1" value="${ordonnanceData.M1 || ordonnanceData.Medicament1 || ''}" placeholder="Nom du m√©dicament">
      <input type="text" id="ordonnance_P1" value="${ordonnanceData.P1 || ordonnanceData.Posologie1 || ''}" placeholder="1 comprim√©, 2 fois/j">
      <input type="text" id="ordonnance_D1" value="${ordonnanceData.D1 || ordonnanceData.Duree1 || ''}" placeholder="7 jours">
    </div>
    
    <!-- M√©dicament 2 -->
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
      <input type="text" id="ordonnance_M2" value="${ordonnanceData.M2 || ordonnanceData.Medicament2 || ''}" placeholder="Nom du m√©dicament">
      <input type="text" id="ordonnance_P2" value="${ordonnanceData.P2 || ordonnanceData.Posologie2 || ''}" placeholder="Posologie">
      <input type="text" id="ordonnance_D2" value="${ordonnanceData.D2 || ordonnanceData.Duree2 || ''}" placeholder="Dur√©e">
    </div>
    
    <!-- M√©dicament 3 -->
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
      <input type="text" id="ordonnance_M3" value="${ordonnanceData.M3 || ordonnanceData.Medicament3 || ''}" placeholder="Nom du m√©dicament">
      <input type="text" id="ordonnance_P3" value="${ordonnanceData.P3 || ordonnanceData.Posologie3 || ''}" placeholder="Posologie">
      <input type="text" id="ordonnance_D3" value="${ordonnanceData.D3 || ordonnanceData.Duree3 || ''}" placeholder="Dur√©e">
    </div>
    
    <label>Remarques</label>
    <textarea id="ordonnance_Remarques" rows="3" placeholder="Instructions suppl√©mentaires...">${ordonnanceData.Remarques || ''}</textarea>
    
    <label>R√©f√©rence Consultation (optionnel)</label>
    <input type="text" id="ordonnance_ref" value="${ordonnanceData.consultation_ref || ''}" placeholder="R√©f√©rence de consultation li√©e">
  `;

  openOrdonnanceFormModal({
    title: isEdit ? "Modifier Ordonnance" : "Nouvelle Ordonnance",
    content: formHtml,
    onSave: async () => {
      const form = {
        IDR: ordonnanceData.IDR,
        patientCIN: document.getElementById("ordonnance_CIN").value.trim(),
        medecinName: document.getElementById("ordonnance_Medecin").value.trim(),
        M1: document.getElementById("ordonnance_M1").value.trim(),
        P1: document.getElementById("ordonnance_P1").value.trim(),
        D1: document.getElementById("ordonnance_D1").value.trim(),
        M2: document.getElementById("ordonnance_M2").value.trim(),
        P2: document.getElementById("ordonnance_P2").value.trim(),
        D2: document.getElementById("ordonnance_D2").value.trim(),
        M3: document.getElementById("ordonnance_M3").value.trim(),
        P3: document.getElementById("ordonnance_P3").value.trim(),
        D3: document.getElementById("ordonnance_D3").value.trim(),
        Remarques: document.getElementById("ordonnance_Remarques").value.trim(),
        consultation_ref: document.getElementById("ordonnance_ref").value.trim()
      };

      if (!form.patientCIN || !form.medecinName) {
        alert("Veuillez remplir les champs obligatoires (CIN patient, M√©decin)");
        return;
      }

      try {
        if (isEdit) {
          await window.electronAPI.updateOrdonnanceByCIN(form);
          alert("Ordonnance modifi√©e avec succ√®s");
        } else {
          await window.electronAPI.addOrdonnanceByCIN(form);
          alert("Ordonnance cr√©√©e avec succ√®s");
        }

        closeModal();
        renderOrdonnancePage();
      } catch (e) {
        console.error(e);
        alert("Erreur lors de l'enregistrement: " + e.message);
      }
    }
  });
}

async function openOrdonnanceEdit(id) {
  try {
    const ordonnance = await window.electronAPI.getOrdonnanceById(id);
    if (ordonnance) {
      openOrdonnanceModal(ordonnance);
    } else {
      alert("Ordonnance non trouv√©e");
    }
  } catch (error) {
    console.error('Error loading ordonnance:', error);
    alert("Erreur lors du chargement de l'ordonnance");
  }
}

async function openOrdonnanceDetails(id) {
  try {
    const ordonnance = await window.electronAPI.getOrdonnanceById(id);
    if (!ordonnance) {
      alert("Ordonnance non trouv√©e");
      return;
    }

    const patient = ordonnance.IDP ? await window.electronAPI.getPatientById(ordonnance.IDP) : null;
    const patientName = patient ? `${patient.Nom} ${patient.Prenom}` : 'N/A';

    const medicaments = [
      { med: ordonnance.Medicament1, pos: ordonnance.Posologie1, dur: ordonnance.Duree1 },
      { med: ordonnance.Medicament2, pos: ordonnance.Posologie2, dur: ordonnance.Duree2 },
      { med: ordonnance.Medicament3, pos: ordonnance.Posologie3, dur: ordonnance.Duree3 }
    ].filter(m => m.med && m.med.trim() !== '');

    const medicamentsHtml = medicaments.length > 0 
      ? medicaments.map(m => `
          <div style="padding: 8px; background: #f8fafc; margin-bottom: 8px; border-radius: 4px;">
            <strong>${escapeHtml(m.med)}</strong><br>
            <small>Posologie: ${escapeHtml(m.pos)} - Dur√©e: ${escapeHtml(m.dur)}</small>
          </div>
        `).join('')
      : '<p style="color: #64748b;">Aucun m√©dicament prescrit</p>';

    const content = `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
          <h4 style="margin-bottom: 16px; color: var(--primary-color);">Informations Patient</h4>
          <p><strong>Nom:</strong> ${escapeHtml(patientName)}</p>
          <p><strong>M√©decin:</strong> ${escapeHtml(ordonnance.NomMedecin || '')}</p>
        </div>
        
        <div>
          <h4 style="margin-bottom: 16px; color: var(--primary-color);">Informations Ordonnance</h4>
          <p><strong>Date:</strong> ${escapeHtml(ordonnance.DateCreation || '')}</p>
          <p><strong>R√©f√©rence:</strong> ${escapeHtml(ordonnance.consultation_ref || 'Non sp√©cifi√©e')}</p>
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4 style="margin-bottom: 16px; color: var(--primary-color);">M√©dicaments Prescrits</h4>
        ${medicamentsHtml}
      </div>
      
      ${ordonnance.Remarques ? `
      <div>
        <h4 style="margin-bottom: 16px; color: var(--primary-color);">Remarques</h4>
        <div style="background: #f8fafc; padding: 16px; border-radius: 4px;">
          ${escapeHtml(ordonnance.Remarques)}
        </div>
      </div>
      ` : ''}
      
      <div style="margin-top: 20px;">
        <button class="btn primary" onclick="generateOrdonnancePDF(${ordonnance.IDR})">
          üìÑ G√©n√©rer PDF
        </button>
      </div>
    `;

    openOrdonnanceFormModal({
      title: "D√©tails Ordonnance",
      content,
      onSave: null
    });

    // Hide save button for details view
    document.getElementById("saveOrdonnanceBtn")?.remove();
    document.getElementById("cancelOrdonnanceBtn").textContent = "Fermer";

  } catch (error) {
    console.error('Error loading ordonnance details:', error);
    alert("Erreur lors du chargement des d√©tails");
  }
}

function generateOrdonnancePDF(ordonnanceId) {
  // This would integrate with your PDF generation logic
  alert("Fonctionnalit√© PDF √† impl√©menter pour l'ordonnance #" + ordonnanceId);
  // You can use the same jsPDF integration as in the patient details
}

async function deleteOrdonnance(id) {
  if (!confirm("√ätes-vous s√ªr de vouloir supprimer cette ordonnance ?")) {
    return;
  }

  try {
    await window.electronAPI.deleteOrdonnance(id);
    alert("Ordonnance supprim√©e avec succ√®s");
    renderOrdonnancePage();
  } catch (error) {
    console.error('Error deleting ordonnance:', error);
    alert("Erreur lors de la suppression de l'ordonnance");
  }
}

function openOrdonnanceFormModal({ title, content, onSave }) {
  const root = document.getElementById("modalRoot");
  root.style.display = "block";

  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" style="max-width: 800px; max-height: 90vh; overflow: auto;">
        <h3>${escapeHtml(title)}</h3>
        <div id="ordonnanceFormContent">
          ${content}
        </div>

        <div class="actions">
          <button class="btn secondary" id="cancelOrdonnanceBtn">Annuler</button>
          ${onSave ? `<button class="btn primary" id="saveOrdonnanceBtn">Enregistrer</button>` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById("cancelOrdonnanceBtn").onclick = closeModal;
  if (onSave) {
    document.getElementById("saveOrdonnanceBtn").onclick = async () => {
      await onSave();
    };
  }
}
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>