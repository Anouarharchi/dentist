<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Secr√©taire</title>
  <style>
    /* CSS Variables for consistent theming */
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --secondary-color: #2c3e50;
      --accent-color: #4caf50;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-bg: #f8f9fa;
      --dark-bg: #20232a;
      --sidebar-width: 240px;
      --right-panel-width: 300px;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * { 
      box-sizing: border-box; 
      margin:0; 
      padding:0; 
      font-family: "Segoe UI", "Roboto", sans-serif; 
    }
    
    body { 
      display:flex; 
      height:100vh; 
      background:#f3f4f6; 
      overflow:hidden;
      color: #333;
    }

    /* Enhanced Sidebar */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--dark-bg); 
      color: white; 
      display:flex; 
      flex-direction:column; 
      padding:20px 0; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 10;
      transition: var(--transition);
    }
    
    .sidebar h2 { 
      text-align:center; 
      margin-bottom:20px; 
      font-weight:500;
      padding: 0 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .sidebar h2::before {
      content: "üë©‚Äçüíº";
      font-size: 1.2rem;
    }
    
    .menu { 
      flex:1; 
    }
    
    .menu-item {
      display:flex; 
      align-items:center; 
      justify-content:space-between;
      padding:14px 16px; 
      cursor:pointer; 
      transition: var(--transition);
      position:relative;
      border-left: 4px solid transparent;
    }
    
    .menu-item.active { 
      background:rgba(255,255,255,0.08); 
      border-left-color: var(--accent-color);
      box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
    }
    
    .menu-item:hover { 
      background:rgba(255,255,255,0.05); 
    }
    
    .menu-item .label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .menu-item .label::before {
      width: 20px;
      text-align: center;
    }
    
    .menu-item[data-page="emploi"] .label::before { content: "üìÖ"; }
    .menu-item[data-page="consultation"] .label::before { content: "ü©∫"; }
    .menu-item[data-page="patients"] .label::before { content: "üë•"; }
    .menu-item[data-page="ordonnance"] .label::before { content: "üìã"; }
    .menu-item[data-page="setting"] .label::before { content: "‚öôÔ∏è"; }
    
    .logout-btn { 
      background: var(--danger-color); 
      border:none; 
      color:white; 
      padding:12px; 
      margin:15px; 
      border-radius:var(--border-radius); 
      cursor:pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .logout-btn:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Main Content Area */
    .main-content { 
      flex:1 1 auto; 
      display:flex; 
      flex-direction:column; 
      padding:20px; 
      min-width:0;
      overflow: hidden;
    }
    
    .main-header { 
      display:flex; 
      align-items:center; 
      gap:12px; 
      justify-content:space-between; 
      margin-bottom:20px; 
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .main-header h3 { 
      font-size:1.5rem; 
      color:#2c3e50;
      font-weight: 600;
    }

    .controls { 
      display:flex; 
      gap:8px; 
      align-items:center; 
      font-size:14px; 
    }
    
    .controls small { 
      margin-left:8px; 
      color:#555;
      font-weight: 500;
      background: #f0f0f0;
      padding: 5px 10px;
      border-radius: 20px;
    }

    .content-area { 
      background:white; 
      flex:1; 
      border-radius:var(--border-radius); 
      padding:20px; 
      box-shadow: var(--box-shadow); 
      overflow:auto;
      position: relative;
    }

    /* Enhanced Timetable */
    .timetable { 
      width:max-content; 
      min-width:100%; 
      border-collapse:collapse;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .timetable th, .timetable td { 
      border:1px solid #e6e6e6; 
      padding:8px; 
      vertical-align:top; 
      min-width:120px; 
      height:70px; 
      font-size:13px; 
    }
    
    .timetable th { 
      background:#f8f9fa; 
      text-align:center;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .time-col { 
      width:80px; 
      background:#f7f7f7; 
      font-weight:bold; 
      text-align:center;
      color: #2c3e50;
    }
    
    .slot { 
      height:100%; 
      cursor:pointer; 
      position:relative;
      transition: var(--transition);
    }
    
    .slot:hover {
      background: rgba(52, 152, 219, 0.05);
    }
    
    .appt { 
      margin:2px; 
      padding:6px; 
      border-radius:4px; 
      font-size:12px; 
      cursor:pointer; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      white-space:nowrap;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: var(--transition);
      font-weight: 500;
    }
    
    .appt:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    /* Enhanced Right Panel */
    .right-panel { 
      width: var(--right-panel-width); 
      flex-shrink:0; 
      background:var(--light-bg); 
      border-left:1px solid #ddd; 
      padding:20px; 
      overflow-y:auto; 
      position:sticky; 
      top:0; 
      height:100vh;
      box-shadow: -2px 0 10px rgba(0,0,0,0.05);
    }
    
    .search-box input { 
      width:calc(100% - 60px); 
      padding:10px; 
      border-radius:var(--border-radius); 
      border:1px solid #ccc; 
      margin-right:6px;
      transition: var(--transition);
    }
    
    .search-box input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    
    .search-row { 
      display:flex; 
      gap:6px; 
      margin-bottom:15px; 
    }
    
    .patient-info { 
      background:white; 
      border-radius:var(--border-radius); 
      padding:15px; 
      box-shadow:0 0 5px rgba(0,0,0,0.05); 
      margin-top:8px;
      border-left: 3px solid var(--primary-color);
    }

    /* Enhanced Modal */
    .modal-backdrop { 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.5); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      z-index:1000;
      backdrop-filter: blur(2px);
    }
    
    .modal { 
      background:white; 
      padding:20px; 
      border-radius:var(--border-radius); 
      width:450px; 
      max-width:95%; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: modalAppear 0.3s ease-out;
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal h3, .modal h4 {
      margin-bottom: 15px;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .modal label { 
      display:block; 
      margin-top:12px; 
      font-size:13px; 
      color:#333;
      font-weight: 500;
    }
    
    .modal input, .modal select, .modal textarea { 
      width:100%; 
      padding:10px; 
      margin-top:6px; 
      border:1px solid #ddd; 
      border-radius:4px;
      transition: var(--transition);
    }
    
    .modal input:focus, .modal select:focus, .modal textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    
    .modal .actions { 
      display:flex; 
      gap:8px; 
      justify-content:flex-end; 
      margin-top:20px; 
    }
    
    .btn { 
      padding:10px 14px; 
      border-radius:var(--border-radius); 
      cursor:pointer; 
      border:none;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn.primary { 
      background:var(--primary-color); 
      color:#fff; 
    }
    
    .btn.primary:hover {
      background: var(--primary-dark);
    }
    
    .btn.warn { 
      background:var(--warning-color); 
      color:#111; 
    }
    
    .btn.danger { 
      background:var(--danger-color); 
      color:#fff; 
    }

    /* Enhanced Patient Table */
    #patientsTable {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    #patientsTable th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #2c3e50;
      border-bottom: 2px solid #e9ecef;
    }
    
    #patientsTable td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
    }
    
    #patientsTable tr:hover {
      background-color: #f8f9fa;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-planned {
      background: #b3e5fc;
      color: #01579b;
    }
    
    .status-confirmed {
      background: #c8e6c9;
      color: #1b5e20;
    }
    
    .status-cancelled {
      background: #ffcdd2;
      color: #b71c1c;
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .right-panel {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        padding: 10px;
      }
      
      .sidebar h2 {
        margin-bottom: 0;
        margin-right: 15px;
      }
      
      .menu {
        display: flex;
        flex: 1;
        overflow-x: auto;
      }
      
      .menu-item {
        white-space: nowrap;
        border-left: none;
        border-bottom: 3px solid transparent;
      }
      
      .menu-item.active {
        border-left: none;
        border-bottom-color: var(--accent-color);
      }
      
      .logout-btn {
        margin: 0;
      }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <!-- Your existing HTML structure remains the same -->
  <div class="sidebar">
    <h2>Secr√©taire</h2>
    <div class="menu">
      <div class="menu-item active" data-page="emploi">
        <span class="label">Emploi du Temps</span>
      </div>

      <div class="menu-item" data-page="consultation">
        <span class="label">Consultation</span>
      </div>

      <div class="menu-item" data-page="patients">
        <span class="label">Patients</span>
      </div>

      <div class="menu-item" data-page="ordonnance">
        <span class="label">Ordonnances</span>
      </div>

      <div class="menu-item" data-page="setting">
        <span class="label">Param√®tres</span>
      </div>
    </div>
    <button id="logoutBtn" class="logout-btn">
      <span>Se d√©connecter</span>
    </button>
  </div>

  <div class="main-content">
    <div class="main-header">
      <h3 id="title">Emploi du Temps ‚Äî Semaine</h3>
      <div class="controls" id="weekControls" style="display:none;">
        <button id="prevWeek" class="btn">‚óÄ</button>
        <button id="todayBtn" class="btn">Aujourd'hui</button>
        <button id="nextWeek" class="btn">‚ñ∂</button>
        <small id="weekRange"></small>
      </div>
    </div>

    <div class="content-area" id="content-area"></div>
  </div>

  <div class="right-panel">
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="Rechercher un patient par nom...">
      <button id="searchBtn" class="btn">üîç</button>
    </div>
    <div id="searchResult"></div>
  </div>

  <div id="modalRoot" style="display:none;"></div>

  <!-- Your existing JavaScript remains unchanged -->
  <script>
    // Your existing JavaScript code remains exactly the same
    const toISODate = d => d.toISOString().split('T')[0];
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    function getMonday(d){ const date=new Date(d); const day=date.getDay(); const diff=date.getDate()-((day+6)%7); return new Date(date.setDate(diff)); }
    function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    let currentWeekStart = getMonday(new Date());
    let appointmentsCache = [];

    const pages = {
      emploi: renderWeek,
      consultation: () => {
        document.getElementById("title").textContent = "Consultation";
        document.getElementById("content-area").innerHTML = `<h2>Consultation</h2><p>Gestion des consultations ici...</p>`;
        document.getElementById('weekControls').style.display = 'none';
      },
      ordonnance: () => {
        document.getElementById("title").textContent = "Ordonnances";
        document.getElementById("content-area").innerHTML = `<h2>Ordonnances</h2><p>Liste des ordonnances ici...</p>`;
        document.getElementById('weekControls').style.display = 'none';
      },
      patients: () => {
        document.getElementById("title").textContent = "Les Patients";
        document.getElementById('weekControls').style.display = 'none';
        renderPatientsPage();
      },
      setting: () => {
        document.getElementById("title").textContent = "Param√®tres";
        document.getElementById("content-area").innerHTML = `<h2>Param√®tres</h2><p>R√©glages de l'application...</p>`;
        document.getElementById('weekControls').style.display = 'none';
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      // Authentication check
      const user = await window.electronAPI.getCurrentUser();
      if(!user || user.Droit.toLowerCase()!=='secretary'){ alert('‚õî Acc√®s refus√©.'); window.location.replace('login.html'); return; }

      document.getElementById('logoutBtn').addEventListener('click', () => window.electronAPI.logout());
      
      // Week control buttons
      document.getElementById('prevWeek').addEventListener('click', () => { currentWeekStart=addDays(currentWeekStart,-7); renderWeek(); });
      document.getElementById('nextWeek').addEventListener('click', () => { currentWeekStart=addDays(currentWeekStart,7); renderWeek(); });
      document.getElementById('todayBtn').addEventListener('click', () => { currentWeekStart=getMonday(new Date()); renderWeek(); });

      // Search
      document.getElementById('searchBtn').addEventListener('click', searchPatient);
      document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key==='Enter') searchPatient(); });

      // Menu navigation
      document.querySelectorAll(".menu-item").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".menu-item").forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
          const page = btn.dataset.page;
          if(pages[page]) pages[page]();
        });
      });

      pages['emploi'](); // default page
    });

    // Render Patients Page 
    async function renderPatientsPage() {
      const area = document.getElementById("content-area");
      area.innerHTML = `<h2>Patients</h2>
        <button class="btn primary" id="addPatientBtn">+ Ajouter un patient</button>
        <br><br>
        <table id="patientsTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f2f2f2;">
              <th style="border:1px solid #ddd; padding:8px;">Nom</th>
              <th style="border:1px solid #ddd; padding:8px;">Pr√©nom</th>
              <th style="border:1px solid #ddd; padding:8px;">CIN</th>
              <th style="border:1px solid #ddd; padding:8px;">T√©l√©phone</th>
              <th style="border:1px solid #ddd; padding:8px;">Ville</th>
              <th style="border:1px solid #ddd; padding:8px;">Action</th>
            </tr>
          </thead>
          <tbody id="patientsTbody"></tbody>
        </table>
      `;

      const patients = await window.electronAPI.getPatients() || [];
      const tbody = document.getElementById("patientsTbody");

      tbody.innerHTML = patients.map(p => `
        <tr>
          <td style="border:1px solid #ddd; padding:6px;">${escapeHtml(p.Nom)}</td>
          <td style="border:1px solid #ddd; padding:6px;">${escapeHtml(p.Prenom)}</td>
          <td style="border:1px solid#ddd; padding:6px;">${escapeHtml(p.CIN || '')}</td>
          <td style="border:1px solid#ddd; padding:6px;">${escapeHtml(p.Tel || '')}</td>
          <td style="border:1px solid#ddd; padding:6px;">${escapeHtml(p.Ville || '')}</td>
          <td style="border:1px solid #ddd; padding:6px;">
            <button class="btn" onclick="openPatientEdit(${p.IDP})">Modifier</button>
            <button class="btn" onclick="openPatientDetails(${p.IDP})">D√©tails</button>
          </td>
        </tr>
      `).join("");

      document.getElementById("addPatientBtn").addEventListener("click", () => openPatientModal());
    }

    function openPatientModal(data = null) {
      const isEdit = !!data;

      const patientData = data || {
        Nom: "", Prenom: "", CIN: "",
        DateNaissance: "",
        Tel: "", Email: "",
        Adresse: "", Ville: "",
        Allergies: "", Remarques: ""
      };

      const formHtml = `
        <label>Nom :</label>
        <input type="text" id="Nom" value="${patientData.Nom}">

        <label>Pr√©nom :</label>
        <input type="text" id="Prenom" value="${patientData.Prenom}">

        <label>CIN :</label>
        <input type="text" id="CIN" value="${patientData.CIN}">

        <label>Date de Naissance :</label>
        <input type="date" id="DateNaissance" value="${patientData.DateNaissance}">

        <label>T√©l√©phone :</label>
        <input type="text" id="Tel" value="${patientData.Tel}">

        <label>Email :</label>
        <input type="email" id="Email" value="${patientData.Email}">

        <label>Adresse :</label>
        <input type="text" id="Adresse" value="${patientData.Adresse}">

        <label>Ville :</label>
        <input type="text" id="Ville" value="${patientData.Ville}">

        <label>Allergies :</label>
        <textarea id="Allergies">${patientData.Allergies}</textarea>

        <label>Remarques :</label>
        <textarea id="Remarques">${patientData.Remarques}</textarea>
      `;

      openPatientFormModal({
        title: isEdit ? "Modifier Patient" : "Ajouter Patient",
        content: formHtml,

        onSave: async () => {
          const form = {
            Nom: document.getElementById("Nom").value,
            Prenom: document.getElementById("Prenom").value,
            CIN: document.getElementById("CIN").value,
            DateNaissance: document.getElementById("DateNaissance").value,
            Tel: document.getElementById("Tel").value,
            Email: document.getElementById("Email").value,
            Adresse: document.getElementById("Adresse").value,
            Ville: document.getElementById("Ville").value,
            Allergies: document.getElementById("Allergies").value,
            Remarques: document.getElementById("Remarques").value
          };

          try {
            if (isEdit) {
              form.IDP = data.IDP;
              await window.electronAPI.updatePatient(form);
              alert("Patient modifi√©.");
            } else {
              await window.electronAPI.addPatient(form);
              alert("Patient ajout√©.");
            }

            closeModal();
            renderPatientsPage();

          } catch(e) {
            console.error(e);
            alert("Erreur lors de l'enregistrement.");
          }
        }
      });
    }

    function openPatientFormModal({ title, content, onSave }) {
      const root = document.getElementById("modalRoot");
      root.style.display = "block";

      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" role="dialog" aria-modal="true" style="max-height:90vh; overflow:auto;">
            <h3>${escapeHtml(title)}</h3>
            <div id="patientFormContent">
              ${content}
            </div>

            <div class="actions">
              <button class="btn" id="cancelPatientBtn">Annuler</button>
              <button class="btn primary" id="savePatientBtn">Enregistrer</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("cancelPatientBtn").onclick = closeModal;
      document.getElementById("savePatientBtn").onclick = async () => {
        await onSave();
      };
    }

    async function openPatientEdit(id) {
      const list = await window.electronAPI.getPatients();
      const p = list.find(x => x.IDP === id);
      openPatientModal(p);
    }

    async function renderWeek(){
      document.getElementById('weekControls').style.display='flex';

      const start = toISODate(currentWeekStart);
      const end = toISODate(addDays(currentWeekStart,6));
      document.getElementById('weekRange').textContent = `${start} ‚Üí ${end}`;

      appointmentsCache = await window.electronAPI.getAppointments({startDate:start,endDate:end})||[];

      const hours=["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];
      const days=Array.from({length:7},(_,i)=>addDays(currentWeekStart,i));

      let html=`<table class="timetable"><thead><tr><th class="time-col">Heures</th>`;
      days.forEach(d=>html+=`<th>${d.toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'2-digit'})}</th>`);
      html+=`</tr></thead><tbody>`;

      hours.forEach(hour=>{
        html+=`<tr><td class="time-col">${hour}</td>`;
        days.forEach(day=>{
          const dateStr=toISODate(day);
          const cellId=`${dateStr}__${hour}`;
          const appts=appointmentsCache.filter(a=>a.DateRv===dateStr && a.HeureRv===hour);
          let cellHtml=`<div class="slot" data-date="${dateStr}" data-time="${hour}" id="${cellId}">`;
          appts.forEach(a=>{
            let color='#b3e5fc';
            if(a.Statut==='Confirm√©') color='#4caf50';
            else if(a.Statut==='Annul√©') color='#ff4c4c';
            cellHtml+=`<div class="appt" data-id="${a.IDRv}" style="background:${color}">${escapeHtml(a.NomPrenom||a.TypePatient||'RDV')}</div>`;
          });
          cellHtml+='</div>';
          html+=`<td>${cellHtml}</td>`;
        });
        html+='</tr>';
      });
      html+='</tbody></table>';
      document.getElementById('content-area').innerHTML=html;

      document.querySelectorAll('.slot').forEach(slot=>{
        slot.addEventListener('click', e=>{
          const apptDiv=e.target.closest('.appt');
          if(apptDiv) openEditModal(apptDiv.dataset.id);
          else openCreateModal(slot.dataset.date, slot.dataset.time);
        });
      });
    }

    function openCreateModal(date,time) {
      openModal({
        title:`Cr√©er RDV ‚Äî ${date} ${time}`,
        data:{IDRv:null,DateRv:date,HeureRv:time,IDP:null,NomPrenom:'',Email:'',Statut:'Planifi√©',TypePatient:'',CIN:''},

        onSave: async data => {
          try {
            // 1) Get all patients
            const patients = await window.electronAPI.getPatients();

            // 2) Find patient by CIN
            const p = patients.find(x => (x.CIN||"").trim().toLowerCase() === data.CIN.toLowerCase());

            if (!p) {
              alert("‚ùå Aucun patient avec ce CIN.");
              return;
            }

            // 3) Use the real patient ID
            data.IDP = p.IDP;

            // 4) Save
            await window.electronAPI.createAppointment(data);

            renderWeek();
            closeModal();
            alert("RDV cr√©√©.");

          } catch(err) {
            console.error(err);
            alert("Erreur cr√©ation RDV.");
          }
        }
      });
    }

    async function openEditModal(IDRv){
      const appt=await window.electronAPI.getAppointment(Number(IDRv));
      if(!appt){alert('RDV introuvable');return;}
      openModal({
        title:`Modifier RDV ‚Äî ${appt.DateRv} ${appt.HeureRv}`,
        data:{...appt},
        onSave:async data=>{try{await window.electronAPI.updateAppointment(data); renderWeek(); closeModal(); alert('RDV modifi√©.');}catch(err){console.error(err);alert('Erreur modification.');}},
        onDelete:async ()=>{if(!confirm('Supprimer ce RDV ?'))return;try{await window.electronAPI.deleteAppointment(Number(IDRv)); renderWeek(); closeModal();alert('RDV supprim√©.');}catch(err){console.error(err);alert('Erreur suppression.');}}
      });
    }

    function openModal({title,data,onSave,onDelete}) {
      const root = document.getElementById('modalRoot'); 
      root.style.display='block';

      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" role="dialog" aria-modal="true">
            <h4>${escapeHtml(title)}</h4>

            <label>CIN du patient</label>
            <input id="m_CIN" value="${escapeHtml(data.CIN||'')}" />

            <label>Nom / NomPrenom</label>
            <input id="m_NomPrenom" value="${escapeHtml(data.NomPrenom||'')}" />

            <label>Email</label>
            <input id="m_Email" value="${escapeHtml(data.Email||'')}" />

            <label>Type</label>
            <input id="m_TypePatient" value="${escapeHtml(data.TypePatient||'')}" />

            <label>Statut</label>
            <select id="m_Statut">
              <option ${data.Statut==='Planifi√©'?'selected':''}>Planifi√©</option>
              <option ${data.Statut==='Confirm√©'?'selected':''}>Confirm√©</option>
              <option ${data.Statut==='Annul√©'?'selected':''}>Annul√©</option>
            </select>

            <label>Date</label>
            <input id="m_DateRv" type="date" value="${escapeHtml(data.DateRv||'')}" />

            <label>Heure</label>
            <input id="m_HeureRv" type="time" value="${escapeHtml(data.HeureRv||'')}" />

            <div class="actions">
              ${onDelete ? '<button id="deleteBtn" class="btn danger">Supprimer</button>' : ''}
              <button id="cancelBtn" class="btn">Annuler</button>
              <button id="saveBtn" class="btn primary">Sauvegarder</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('cancelBtn').onclick = closeModal;

      document.getElementById('saveBtn').onclick = async () => {
        const payload = {
          CIN: document.getElementById('m_CIN').value.trim(),
          IDRv: data.IDRv || null,
          IDP: data.IDP || null,
          NomPrenom: document.getElementById('m_NomPrenom').value.trim(),
          Email: document.getElementById('m_Email').value.trim(),
          TypePatient: document.getElementById('m_TypePatient').value.trim(),
          Statut: document.getElementById('m_Statut').value,
          DateRv: document.getElementById('m_DateRv').value,
          HeureRv: document.getElementById('m_HeureRv').value
        };

        await onSave(payload);
      };

      if(onDelete) document.getElementById('deleteBtn').onclick = onDelete;
    }

    function closeModal(){ const root=document.getElementById('modalRoot'); root.style.display='none'; root.innerHTML=''; }

    async function openPatientDetails(id) {
      const patients = await window.electronAPI.getPatients();
      const p = patients.find(x => x.IDP === id);
      if (!p) return alert("Patient introuvable");

      const content = `
        <div id="patientDetailsContent">
          <p><strong>Nom:</strong> ${escapeHtml(p.Nom)}</p>
          <p><strong>Pr√©nom:</strong> ${escapeHtml(p.Prenom)}</p>
          <p><strong>CIN:</strong> ${escapeHtml(p.CIN)}</p>
          <p><strong>Date de Naissance:</strong> ${escapeHtml(p.DateNaissance)}</p>
          <p><strong>T√©l√©phone:</strong> ${escapeHtml(p.Tel)}</p>
          <p><strong>Email:</strong> ${escapeHtml(p.Email)}</p>
          <p><strong>Adresse:</strong> ${escapeHtml(p.Adresse)}</p>
          <p><strong>Ville:</strong> ${escapeHtml(p.Ville)}</p>
          <p><strong>Allergies:</strong> ${escapeHtml(p.Allergies)}</p>
          <p><strong>Remarques:</strong> ${escapeHtml(p.Remarques)}</p>
        </div>
        <button class="btn primary" id="exportPdfBtn">Exporter PDF</button>
      `;

      openPatientFormModal({
        title: "D√©tails Patient",
        content,
        onSave: null // read-only
      });

      // hide Save button, rename Cancel to Fermer
      document.getElementById("savePatientBtn")?.remove();
      document.getElementById("cancelPatientBtn").textContent = "Fermer";

      // PDF export
      document.getElementById("exportPdfBtn").onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        let y = 10;
        const lineHeight = 8;

        const addLine = (label, value) => {
          doc.text(`${label}: ${value || ''}`, 10, y);
          y += lineHeight;
        };

        addLine("Nom", p.Nom);
        addLine("Pr√©nom", p.Prenom);
        addLine("CIN", p.CIN);
        addLine("Date de Naissance", p.DateNaissance);
        addLine("T√©l√©phone", p.Tel);
        addLine("Email", p.Email);
        addLine("Adresse", p.Adresse);
        addLine("Ville", p.Ville);
        addLine("Allergies", p.Allergies);
        addLine("Remarques", p.Remarques);

        doc.save(`${p.CIN}.pdf`);
      };
    }

    async function searchPatient() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!q) return;

      const patients = await window.electronAPI.getPatients() || [];

      // Search by CIN OR Nom OR "Prenom Nom"
      const found = patients.find(p => 
        ((p.CIN || '').toLowerCase() === q) || 
        ((p.Nom || '').toLowerCase() === q) || 
        (((p.Prenom || '') + ' ' + (p.Nom || '')).toLowerCase() === q)
      );

      const resDiv = document.getElementById('searchResult');

      if (found) {
        resDiv.innerHTML = `
          <div class="patient-info">
            <p><strong>${escapeHtml(found.Nom)} ${escapeHtml(found.Prenom || '')}</strong></p>
            <p>CIN: ${escapeHtml(found.CIN || '')}</p>
            <p>T√©l√©: ${escapeHtml(found.Tel || '')}</p>
            <p>Email: ${escapeHtml(found.Email || '')}</p>
          </div>
        `;
      } else {
        resDiv.innerHTML = '';
        alert('‚ùå Patient non trouv√©.');
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>