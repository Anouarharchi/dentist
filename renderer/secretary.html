<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord - Secr√©taire</title>
 <style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: "Segoe UI", sans-serif;
  }

  body {
    display: flex;
    height: 100vh;
    background: #f3f4f6;
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    width: 220px;
    background: #20232a;
    color: white;
    display: flex;
    flex-direction: column;
    padding: 20px 0;
  }
  .sidebar h2 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: normal;
  }
  .menu {
    flex: 1;
  }
  .menu button {
    width: 100%;
    padding: 12px;
    text-align: left;
    background: none;
    border: none;
    color: white;
    font-size: 15px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .menu button:hover,
  .menu button.active {
    background: #2d313a;
  }
  .logout-btn {
    background: #ff4c4c;
    border: none;
    color: white;
    padding: 10px;
    margin: 10px;
    border-radius: 4px;
    cursor: pointer;
  }

  /* Main */
  .main-content {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    padding: 20px;
    min-width: 0; /* allow shrinking */
  }
  .main-header {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .main-header h3 {
    font-size: 18px;
    color: #333;
  }
  .controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .content-area {
    background: white;
    flex: 1;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 0 5px rgba(0,0,0,0.08);
    overflow-x: auto; /* horizontal scroll if table is wide */
    overflow-y: auto; /* vertical scroll */
  }

  /* Timetable */
  .timetable {
    width: max-content; /* table width adjusts to content */
    min-width: 100%;
    border-collapse: collapse;
  }
  .timetable th,
  .timetable td {
    border: 1px solid #e6e6e6;
    padding: 4px;
    vertical-align: top;
    min-width: 100px; /* smaller columns */
    height: 60px; /* shorter rows */
    font-size: 13px;
  }
  .timetable th {
    background: #fafafa;
    text-align: center;
  }
  .time-col {
    width: 76px;
    background: #f7f7f7;
    font-weight: bold;
    text-align: center;
  }
  .slot {
    height: 100%;
    cursor: pointer;
    position: relative;
  }
  .appt {
    background: #b3e5fc;
    margin: 2px;
    padding: 4px;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Right panel */
  .right-panel {
    width: 300px;
    flex-shrink: 0;
    background: #f8f9fa;
    border-left: 1px solid #ddd;
    padding: 20px;
    overflow-y: auto;
    position: sticky;
    top: 0;
    height: 100vh;
  }
  .search-box input {
    width: calc(100% - 60px);
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #aaa;
    margin-right: 6px;
  }
  .search-row {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
  }
  .patient-info {
    background: white;
    border-radius: 6px;
    padding: 12px;
    box-shadow: 0 0 5px rgba(0,0,0,0.05);
    margin-top: 8px;
  }

  /* Modal */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal {
    background: white;
    padding: 16px;
    border-radius: 8px;
    width: 420px;
    max-width: 95%;
  }
  .modal label {
    display: block;
    margin-top: 8px;
    font-size: 13px;
    color: #333;
  }
  .modal input,
  .modal select,
  .modal textarea {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .modal .actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 12px;
  }
  .btn {
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    border: none;
  }
  .btn.primary {
    background: #007bff;
    color: #fff;
  }
  .btn.warn {
    background: #ffbf00;
    color: #111;
  }
  .btn.danger {
    background: #ff4c4c;
    color: #fff;
  }
</style>

</head>
<body>
  <div class="sidebar">
    <h2>Secr√©taire</h2>
    <div class="menu">
      <button class="menu-item active" data-page="emploi">üóìÔ∏è Emploi du Temps</button>
      <button class="menu-item" data-page="consultation">ü©∫ Consultation</button>
      <button class="menu-item" data-page="ordonnance">üíä Ordonnances</button>
      <button class="menu-item" data-page="patients">üë®‚Äç‚öïÔ∏è Les Patients</button>
      <button class="menu-item" data-page="rendezvous">üìÖ Rendez-vous</button>
      <button class="menu-item" data-page="setting">‚öôÔ∏è Param√®tres</button>
    </div>
    <button id="logoutBtn" class="logout-btn">Se d√©connecter</button>
  </div>

  <div class="main-content">
    <div class="main-header">
      <h3 id="title">Emploi du Temps ‚Äî Semaine</h3>
      <div class="controls">
        <button id="prevWeek" class="btn">‚óÄ</button>
        <button id="todayBtn" class="btn">Aujourd'hui</button>
        <button id="nextWeek" class="btn">‚ñ∂</button>
        <div style="width:12px"></div>
        <small id="weekRange"></small>
      </div>
    </div>

    <div class="content-area" id="content-area">
      <!-- timetable will be injected here -->
    </div>
  </div>

  <div class="right-panel">
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="Rechercher un patient par nom...">
      <button id="searchBtn" class="btn">üîç</button>
    </div>
    <div id="searchResult"></div>
    <hr style="margin:12px 0;">
    <div>
      <h4>Rendez-vous rapides</h4>
      <p>Click un cr√©neau dans le tableau pour ajouter un RDV.</p>
    </div>
  </div>

  <!-- Modal (hidden) -->
  <div id="modalRoot" style="display:none;"></div>

  <script>
    // Helpers
    const toISODate = d => d.toISOString().split('T')[0]; // YYYY-MM-DD
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };

    // Access control + initial load
    let currentWeekStart = getMonday(new Date()); // Date object
    let appointmentsCache = []; // loaded appointments for the week

    window.addEventListener('DOMContentLoaded', async () => {
      const user = await window.electronAPI.getCurrentUser();
      if (!user || user.Droit.toLowerCase() !== 'secretary') {
        alert('‚õî Acc√®s refus√©.');
        window.location.replace('login.html');
        return;
      }

      document.getElementById('logoutBtn').addEventListener('click', () => window.electronAPI.logout());

      // Controls
      document.getElementById('prevWeek').addEventListener('click', () => { currentWeekStart = addDays(currentWeekStart, -7); renderWeek(); });
      document.getElementById('nextWeek').addEventListener('click', () => { currentWeekStart = addDays(currentWeekStart, 7); renderWeek(); });
      document.getElementById('todayBtn').addEventListener('click', () => { currentWeekStart = getMonday(new Date()); renderWeek(); });

      document.getElementById('searchBtn').addEventListener('click', searchPatient);
      document.getElementById('searchInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') searchPatient(); });

      renderWeek();
    });

    // Render week timetable
    async function renderWeek() {
      const start = toISODate(currentWeekStart);
      const end = toISODate(addDays(currentWeekStart, 6));
      document.getElementById('weekRange').textContent = `${start} ‚Üí ${end}`;

      // Fetch appointments for week via IPC
      appointmentsCache = await window.electronAPI.getAppointments({ startDate: start, endDate: end }) || [];

      const hours = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];
      const days = Array.from({length:7}, (_,i) => addDays(currentWeekStart, i));
      // build table
      let html = `<table class="timetable"><thead><tr><th class="time-col">Heures</th>`;
      days.forEach(d => html += `<th>${d.toLocaleDateString('fr-FR', {weekday:'long', day:'2-digit', month:'2-digit'})}</th>`);
      html += `</tr></thead><tbody>`;
      hours.forEach(hour => {
        html += `<tr><td class="time-col">${hour}</td>`;
        days.forEach(day => {
          const dateStr = toISODate(day);
          const cellId = `${dateStr}__${hour}`;
          // find appointments matching DateRv and HeureRv (exact match)
          const appts = appointmentsCache.filter(a => a.DateRv === dateStr && a.HeureRv === hour);
          let cellHtml = `<div class="slot" data-date="${dateStr}" data-time="${hour}" id="${cellId}">`;
          appts.forEach(a => {
            cellHtml += `<div class="appt" data-id="${a.IDRv}">${escapeHtml(a.NomPrenom || a.TypePatient || 'RDV')}</div>`;
          });
          cellHtml += `</div>`;
          html += `<td>${cellHtml}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('content-area').innerHTML = html;

      // attach click handlers
      document.querySelectorAll('.slot').forEach(slot => {
        slot.addEventListener('click', (e) => {
          // if clicked on an existing appt element, open edit, else open create
          const apptDiv = e.target.closest('.appt');
          if (apptDiv) {
            const IDRv = apptDiv.dataset.id;
            openEditModal(IDRv);
          } else {
            const date = slot.dataset.date;
            const time = slot.dataset.time;
            openCreateModal(date, time);
          }
        });
      });
    }

    // Create appointment modal
    function openCreateModal(date, time) {
      openModal({
        title: `Cr√©er RDV ‚Äî ${date} ${time}`,
        data: { IDRv: null, DateRv: date, HeureRv: time, IDP: null, NomPrenom: '', Email: '', Statut: 'Planifi√©', TypePatient: '' },
        onSave: async (data) => {
          // create: call IPC createAppointment
          try {
            const id = await window.electronAPI.createAppointment(data);
            // simple refresh
            renderWeek();
            closeModal();
            alert('RDV cr√©√©.');
          } catch (err) {
            console.error(err);
            alert('Erreur cr√©ation RDV.');
          }
        }
      });
    }

    // Edit appointment modal
    async function openEditModal(IDRv) {
      const appt = await window.electronAPI.getAppointment(Number(IDRv));
      if (!appt) { alert('RDV introuvable'); return; }
      openModal({
        title: `Modifier RDV ‚Äî ${appt.DateRv} ${appt.HeureRv}`,
        data: { ...appt },
        onSave: async (data) => {
          try {
            await window.electronAPI.updateAppointment(data);
            renderWeek();
            closeModal();
            alert('RDV modifi√©.');
          } catch (err) {
            console.error(err);
            alert('Erreur modification.');
          }
        },
        onDelete: async () => {
          if (!confirm('Supprimer ce RDV ?')) return;
          try {
            await window.electronAPI.deleteAppointment(Number(IDRv));
            renderWeek();
            closeModal();
            alert('RDV supprim√©.');
          } catch (err) {
            console.error(err);
            alert('Erreur suppression.');
          }
        }
      });
    }

    // Generic modal helper (create/edit)
    function openModal({ title, data, onSave, onDelete }) {
      const root = document.getElementById('modalRoot');
      root.style.display = 'block';
      root.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal" role="dialog" aria-modal="true">
            <h4>${escapeHtml(title)}</h4>
            <label>Nom / NomPrenom</label>
            <input id="m_NomPrenom" value="${escapeHtml(data.NomPrenom || '')}" />
            <label>Email</label>
            <input id="m_Email" value="${escapeHtml(data.Email || '')}" />
            <label>Type</label>
            <input id="m_TypePatient" value="${escapeHtml(data.TypePatient || '')}" />
            <label>Statut</label>
            <select id="m_Statut">
              <option ${data.Statut==='Planifi√©'?'selected':''}>Planifi√©</option>
              <option ${data.Statut==='Confirm√©'?'selected':''}>Confirm√©</option>
              <option ${data.Statut==='Annul√©'?'selected':''}>Annul√©</option>
            </select>
            <label>Date</label>
            <input id="m_DateRv" type="date" value="${escapeHtml(data.DateRv || '')}" />
            <label>Heure</label>
            <input id="m_HeureRv" type="time" value="${escapeHtml(data.HeureRv || '')}" />
            <div class="actions">
              ${ onDelete ? '<button id="deleteBtn" class="btn danger">Supprimer</button>' : '' }
              <button id="cancelBtn" class="btn">Annuler</button>
              <button id="saveBtn" class="btn primary">Sauvegarder</button>
            </div>
          </div>
        </div>
      `;

      // listeners
      document.getElementById('cancelBtn').onclick = closeModal;
      document.getElementById('saveBtn').onclick = async () => {
        const payload = {
          IDRv: data.IDRv || null,
          IDP: data.IDP || null,
          NomPrenom: document.getElementById('m_NomPrenom').value.trim(),
          Email: document.getElementById('m_Email').value.trim(),
          TypePatient: document.getElementById('m_TypePatient').value.trim(),
          Statut: document.getElementById('m_Statut').value,
          DateRv: document.getElementById('m_DateRv').value,
          HeureRv: document.getElementById('m_HeureRv').value
        };
        await onSave(payload);
      };
      if (onDelete) {
        document.getElementById('deleteBtn').onclick = onDelete;
      }
    }

    function closeModal() {
      const root = document.getElementById('modalRoot');
      root.style.display = 'none';
      root.innerHTML = '';
    }

    // Patient search using getPatients()
    async function searchPatient() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!q) return;
      const patients = await window.electronAPI.getPatients() || [];
      const found = patients.find(p => (p.Nom || '').toLowerCase() === q || ((p.Prenom||'') + ' ' + (p.Nom||'')).toLowerCase() === q);
      const resDiv = document.getElementById('searchResult');
      if (found) {
        resDiv.innerHTML = `
          <div class="patient-info">
            <p><strong>${escapeHtml(found.Nom)} ${escapeHtml(found.Prenom||'')}</strong></p>
            <p>CIN: ${escapeHtml(found.CIN||'')}</p>
            <p>T√©l√©: ${escapeHtml(found.Tel||'')}</p>
            <p>Email: ${escapeHtml(found.Email||'')}</p>
          </div>`;
      } else {
        resDiv.innerHTML = '';
        alert('‚ùå Patient non trouv√©.');
      }
    }

    // Utilities
    function getMonday(d) {
      const date = new Date(d);
      const day = date.getDay(); // 0 (Sun) - 6
      const diff = date.getDate() - ((day + 6) % 7);
      return new Date(date.setDate(diff));
    }
    function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  </script>
</body>
</html>
